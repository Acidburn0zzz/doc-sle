<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd" [
 <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
 <!ENTITY % entities SYSTEM "entity-decl.ent">
 %entities;
 ]>
<!-- 2014-03-25 tbazant: info sources
 *** Miklos Szeredi is bugowner, Dirk MÃ¼ller is maintainer ***
 https://wiki.archlinux.org/index.php/autofs
 https://docs.fedoraproject.org/en-US/Fedora/14/html/Storage_Administration_Guide/s1-nfs-client-config-autofs.html
 https://help.ubuntu.com/community/Autofs
 /usr/share/doc/packages/autofs
 -->
<chapter id="cha.autofs">
 <title>On-Demand Mounting with Autofs</title><indexterm>
 <primary>AutoFS</primary></indexterm>
 <abstract>
  <para>
   <systemitem>autofs</systemitem> is a program that automatically mounts
   specified directories on an on-demand basis. It is based on a kernel
   module for high efficiency, and can manage both local directories and
   networks shares. These automatic mount points are mounted only when they
   are accessed, and unmounted after a period of inactivity. This on-demand
   behavior saves bandwidth and results in better performance than static
   mounts managed by <filename>/etc/fstab</filename>. While
   <systemitem>autofs</systemitem> is a control script,
   <command>automount</command> is the command (daemon) that does the actual
   auto-mounting.
  </para>
 </abstract>
 <sect1>
  <title>Installation</title>

  <para>
   <systemitem>autofs</systemitem> is not installed on &productname; by
   default. To make use of its auto-mounting capabilities, first install it
   with
  </para>

<screen>sudo zypper install autofs</screen>
 </sect1>
 <sect1>
  <title>Configuration</title>

  <para>
   You have to configure <systemitem>autofs</systemitem> manually by editing
   its configuration files with a text editor, such as
   <command>vim</command>. There are two basic steps to configure
   <systemitem>autofs</systemitem>&mdash;the <emphasis>master</emphasis> map
   file, and specific map files.
  </para>

  <sect2>
   <title>The Master Map File</title>
   <para>
    The default master configuration file for
    <systemitem>autofs</systemitem> is <filename>/etc/auto.master</filename>
    . You can change its location by changing the value of the
    <option>DEFAULT_MASTER_MAP_NAME</option> option in
    <filename>/etc/sysconfig/autofs</filename>. Here is the content of the
    default one for &productname;:
   </para>
<screen>#
# Sample auto.master file
# This is an automounter map and it has the following format
# key [ -mount-options-separated-by-comma ] location
# For details of the format look at autofs(5).<co id="co.autofs.manpage"/>
#
#/misc  /etc/auto.misc<co id="co.autofs.map"/>
#/net -hosts
#
# Include /etc/auto.master.d/*.autofs<co id="co.autofs.include"/>
#
#+dir:/etc/auto.master.d
#
# Include central master map if it can be found using
# nsswitch sources.
#
# Note that if there are entries for /net or /misc (as
# above) in the included master map any keys that are the
# same will not be seen as the first read key seen takes
# precedence.
#
+auto.master<co id="co.autofs.plus"/></screen>
   <calloutlist>
    <callout arearefs="co.autofs.manpage">
     <para>
      The <systemitem>autofs</systemitem> manual page (<command>man 5
      autofs</command>) offers a lot of valuable information on the format
      of the automounter maps.
     </para>
    </callout>
    <callout arearefs="co.autofs.map">
     <para>
      Although commented out (#) by default, this is an example of a simple
      automounter mapping syntax.
     </para>
    </callout>
    <callout arearefs="co.autofs.include">
     <para>
      In case you need to split the master map into several files, uncomment
      the line, and put the mappings (suffixed with
      <literal>.autofs</literal>) in the
      <filename>/etc/auto.master.d/</filename> directory.
     </para>
    </callout>
    <callout arearefs="co.autofs.plus">
     <para>
      <literal>+auto.master</literal> ensures that those using NIS (see
      <xref
    linkend="sec.nis.server"/> for more information on NIS) will
      still find their master map.
     </para>
    </callout>
   </calloutlist>
   <para>
    The lines that describe the mount point and the location of the map,
    have three fields with the following syntax:
   </para>
<screen>mount point     map name     options</screen>
   <variablelist>
    <varlistentry>
     <term>mount point</term>
     <listitem>
      <para>
       The location where to mount the <systemitem>autofs</systemitem>
       filesystem, such as <literal>/home</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>map name</term>
     <listitem>
      <para>
       The name of a map source to use for mounting. For the syntax of the
       maps files, see <xref linkend="autofs.mapfiles"/>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>options</term>
     <listitem>
      <para>
       These options (if specified) will apply as defaults to all entries in
       the given map.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     For more detailed information on the specific values of the optional
     <literal>map-type</literal>, <literal>format</literal>, and
     <literal>options</literal>, see the <guimenu>auto.master</guimenu>
     manual page (<command>man 5 auto.master</command>).
    </para>
   </tip>
   <para>
    The following entry in <filename>auto.master</filename> tells
    <systemitem>autofs</systemitem> to look in
    <filename>/etc/auto.smb</filename>, and create mount points in the
    <filename>/smb</filename> directory.
   </para>
<screen>/smb   /etc/auto.smb</screen>
   <sect3 id="autofs.directmount">
    <title>Direct Mounts</title>
    <para>
     Direct mounts create a mount point at the path specified inside the
     relevant map file. Instead of specifying the mount point in
     <filename>auto.master</filename>, replace the mount point field with
     <literal>/-</literal>. For example, the following line tells
     <systemitem>autofs</systemitem> to create a mount point at the place
     specified in <filename>auto.smb</filename>:
    </para>
<screen>/-        /etc/auto.smb</screen>
    <tip>
     <title>Maps without Full Path</title>
     <para>
      If the map file is not specified with its full local or network path,
      it is located using the Name Service Switch (NSS) configuration:
     </para>
<screen>/-        auto.smb</screen>
    </tip>
   </sect3>
  </sect2>

  <sect2 id="autofs.mapfiles">
   <title>Map Files</title>
   <important>
    <title>Other Types of Maps</title>
    <para>
     Although <emphasis>files</emphasis> are the most common types of maps
     for auto-mounting with <systemitem>autofs</systemitem>, there ara other
     types as well. A map specification can be the output of a command, or a
     result of a query in LDAP or database. For more detailed information on
     map types, see the manual page <command>man 5 auto.master</command>.
    </para>
   </important>
   <para>
    Map files specify the (local or network) source location, and the mount
    point where to mount the source locally. The general format of maps is
    similar to the master map. The difference is that the
    <emphasis>options</emphasis> appear between the mount point and the
    location instead of at the end of the entry:
   </para>
<screen>mount point     options     location</screen>
   <variablelist>
    <varlistentry>
     <term>mount point</term>
     <listitem>
      <para>
       Specifies where to mount the source location. This can be either a
       single directory name (so called <emphasis>indirect</emphasis> mount)
       to be added to the base mount point specified in
       <filename>auto.master</filename>, or the full path of the mount point
       (direct mount, see <xref linkend="autofs.directmount"/>).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>options</term>
     <listitem>
      <para>
       Specifies optional comma separated list of mount options for the
       relevant entries. If <filename>auto.master</filename> contains
       options for this map file as well, theses are appended.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>location</term>
     <listitem>
      <para>
       Specifies from where the file system is to be mounted. In is usually
       an NFS or SMB volume in the usual notation
       <literal>host_name:path_name</literal>. If the file system to be
       mounted begins with a '/' (such as local <filename>/dev</filename>
       entries or smbfs shares), a colon symbl ':' needs to be prefixed,
       such as <literal>:/dev/sda1</literal>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
<!-- 2014-03-26 tbazant: skeleton
 +installation and configuration
  - sudo zypper in autofs
  - master map file
    - /etc/sysconfig/autofs
    - direct vs indirect maps
    - mount-point map-name options
  - map files
    - mount-point   [options]   location
  - control by systemd
 +Advanced Usage
  - /net and /smb
  - wildcards
 + File system specific
  - CIFS
  - sshfs (fuse)
 + Troubleshooting
  -sudo automount -f -v
 -->
</chapter>
