<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd" [
  <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>
<chapter id="isns" lang="en">
  <title>iSNS for Linux</title>
  <para>
   Storage area networks (SANs) can contain many disk drives that are
   dispersed across complex networks. This can make device discovery and
   device ownership difficult. iSCSI initiators must be able to identify
   storage resources in the SAN and determine whether they have access to
   them.
  </para>
  <para>
   Internet Storage Name Service (iSNS) is a standards-based service that
   facilitates the automated discovery, management, and configuration of
   iSCSI devices on a TCP/IP network. iSNS provides intelligent storage
   discovery and management services comparable to those found in Fibre
   Channel networks.
  </para>
  <important>
   <para>
    iSNS should be used only in secure internal networks.
   </para>
  </important>
  <sect1 id="sec.isns.overview">
   <title>How iSNS Works</title>

   <para>
    For an iSCSI initiator to discover iSCSI targets, it needs to identify
    which devices in the network are storage resources and what IP addresses
    it needs to access them. A query to an iSNS server returns a list of
    iSCSI targets and the IP addresses that the initiator has permission to
    access.
   </para>

   <para>
    Using iSNS, you create iSNS discovery domains and discovery domain sets.
    You then group or organize iSCSI targets and initiators into discovery
    domains and group the discovery domains into discovery domain sets. By
    dividing storage nodes into domains, you can limit the discovery process
    of each host to the most appropriate subset of targets registered with
    iSNS, which allows the storage network to scale by reducing the number
    of unnecessary discoveries and by limiting the amount of time each host
    spends establishing discovery relationships. This lets you control and
    simplify the number of targets and initiators that must be discovered.
   </para>

   <figure pgwide="0" id="bcna0wb">
    <title>iSNS Discovery Domains and Discovery Domain Sets</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="isns_a.png" width="329pt" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="isns_a.png" width="329pt" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>

   <para>
    Both iSCSI targets and iSCSI initiators use iSNS clients to initiate
    transactions with iSNS servers by using the iSNS protocol. They then
    register device attribute information in a common discovery domain,
    download information about other registered clients, and receive
    asynchronous notification of events that occur in their discovery
    domain.
   </para>

   <para>
    iSNS servers respond to iSNS protocol queries and requests made by iSNS
    clients using the iSNS protocol. iSNS servers initiate iSNS protocol
    state change notifications and store properly authenticated information
    submitted by a registration request in an iSNS database.
   </para>

   <para>
    Some of the benefits provided by iSNS for Linux include:
   </para>

   <itemizedlist>
    <listitem>
     <para>
      Provides an information facility for registration, discovery, and
      management of networked storage assets.
     </para>
    </listitem>
    <listitem>
     <para>
      Integrates with the DNS infrastructure.
     </para>
    </listitem>
<!--   <listitem>
    <para>
     Provides access control for registered targets and initiators
    </para>
   </listitem> -->
    <listitem>
     <para>
      Consolidates registration, discovery, and management of iSCSI storage.
     </para>
    </listitem>
    <listitem>
     <para>
      Simplifies storage management implementations.
     </para>
    </listitem>
    <listitem>
     <para>
      Improves scalability compared to other discovery methods.
     </para>
    </listitem>
   </itemizedlist>

   <para>
    An example of the benefits iSNS provides can be better understood
    through the following scenario:
   </para>

<!-- access control is not supported according to hare. And of
  course, you may always circumvent the iSNS server and discover the
  target directly -->

   <para>
    Suppose you have a company that has 100 iSCSI initiators and 100 iSCSI
    targets. Depending on your configuration, all iSCSI initiators could
    potentially try to discover and connect to any of the 100 iSCSI targets.
    This could create discovery and connection difficulties. By grouping
    initiators and targets into discovery domains, you can prevent iSCSI
    initiators in one department from discovering the iSCSI targets in
    another department. The result is that the iSCSI initiators in a
    specific department only discover those iSCSI targets that are part of
    the department&rsquo;s discovery domain.
   </para>
  </sect1>
  <sect1 id="sec.iscsi.setup">
   <title>Installing iSNS Server for Linux</title>

   <para>
    iSNS Server for Linux is included with SLES 10 SP2 and later, but is not
    installed or configured by default. You must install the iSNS package
    modules (<filename>isns</filename> and <filename>yast2-isns</filename>
    modules) and configure the iSNS service.
   </para>

<!-- this funtionality defined in rfc, and the slave side seems to be
 sort of implemented, the master Ñ–s not available right now.
  <para>
   iSNS needs to be installed on only one server on your network. To
   provide an added level of redundancy, you can configure iSNS to be a
   cluster resource that can be failed over or migrated to another server
   on your network.
  </para>
  -->

   <note>
    <para>
     iSNS can be installed on the same server where iSCSI target or iSCSI
     initiator software is installed. Installing both the iSCSI target
     software and iSCSI initiator software on the same server is not
     supported.
    </para>
   </note>

   <para>
    To install iSNS for Linux:
   </para>

   <procedure id="bgchygw">
    <step id="bgchygx">
     <para>
      Start &yast; and select <guimenu>Network Services</guimenu><guimenu>iSNS
      Server</guimenu>.
     </para>
    </step>
    <step id="bi0bpeh">
     <para>
      When prompted to install the <filename>isns</filename> package, click
      <guimenu>Install</guimenu>.
     </para>
    </step>
    <step id="bi0bq1e">
     <para>
      Follow the install instructions to provide the &productname;
      installation disks.
     </para>
     <para role="intro">
      When the installation is complete, the iSNS Service configuration
      dialog box opens automatically to the <guimenu>Service</guimenu> tab.
     </para>
     <informalfigure pgwide="0">
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="isns_config_a.png" width="307pt" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="isns_config_a.png" width="307pt" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step id="bi0bxbd">
     <para>
      In <guimenu>Address of iSNS Server</guimenu>, specify the DNS name or
      IP address of the iSNS Server.
     </para>
    </step>
    <step id="bgchygy">
     <para>
      In <guimenu>Service Start</guimenu>, select one of the following:
     </para>
     <itemizedlist>
      <listitem>
       <formalpara id="bi0c15l">
        <title>When Booting:</title>
        <para>
         The iSNS service starts automatically on server startup.
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara id="bi0c69a">
        <title>Manually (Default):</title>
        <para>
         The iSNS service must be started manually by entering <command>sudo
         systemctl start isns.service</command> at the server console of the
         server where you install it.
        </para>
       </formalpara>
      </listitem>
     </itemizedlist>
    </step>
    <step id="bi0c2ei">
     <para>
      Specify the following firewall settings:
     </para>
     <itemizedlist>
      <listitem>
       <formalpara id="bi0c69b">
        <title>Open Port in Firewall:</title>
        <para>
         Select the check box to open the firewall and allow access to the
         service from remote computers. The firewall port is closed by
         default.
        </para>
       </formalpara>
      </listitem>
      <listitem>
       <formalpara id="bi0c69c">
        <title>Firewall Details:</title>
        <para>
         If you open the firewall port, the port is open on all network
         interfaces by default. Click <guimenu>Firewall Details</guimenu> to
         select interfaces on which to open the port, select the network
         interfaces to use, then click <guimenu>OK</guimenu>.
        </para>
       </formalpara>
      </listitem>
     </itemizedlist>
    </step>
    <step id="bgchygz">
     <para>
      Click <guimenu>Finish</guimenu> to apply the configuration settings
      and complete the installation.
     </para>
    </step>
    <step id="bi0c7d1">
     <para>
      Continue with <xref linkend="bgchyh0" xrefstyle="SectTitleOnPage"/>.
     </para>
    </step>
   </procedure>
  </sect1>
  <sect1 id="bgchyh0">
   <title>Configuring iSNS Discovery Domains</title>

<!-- we do that in the respective iSCSI sections.
  <sect2 id="btzqeya">
   <title>Configuring iSCSI Targets and Initiators to Use iSNS</title>
   <para>
    To configure iSCSI targets and initiators to use iSNS, you must edit
    the iSCSI configuration file on each iSCSI target and initiator server
    and add lines that specify the iSNS server address.
   </para>
   <bridgehead id="btzqhcq">Editing the iSCSI Target Configuration File</bridgehead>
   <para>
    Edit the <filename>/etc/ietd.conf</filename> file and add the following
    line:
   </para>
   <para>
    iSNSServer <replaceable>isns_server_ip_address</replaceable>
   </para>
   <para>
    Replace <replaceable>isns_server_ip_address</replaceable> with the IP
    address of the server where you installed iSNS.
   </para>
   <para>
    A commented-out section with this line might already exist in the
    configuration file. If this is the case, you only need to replace the
    sample IP address with the IP address of your iSNS server.
   </para>
   <bridgehead id="bumds3b">Editing the iSCSI Initiator Configuration File</bridgehead>
   <para>
    Edit the <filename>/etc/iscsi/iscsid.conf</filename> file and add the
    following lines:
   </para>
   <para>
    isns.address = <replaceable>isns_server_ip_address</replaceable>
   </para>
   <para>
    isns.port = 3205
   </para>
   <para>
    Replace <replaceable>isns_server_ip_address</replaceable> with the IP
    address of the server where you installed iSNS.
   </para>
   <para>
    A commented-out section with these lines should already exist in the
    configuration file. If this is the case, you only need to replace the
    sample IP address with the IP address of your iSNS server.
   </para>
  </sect2> -->

   <para>
    In order for iSCSI initiators and targets to use the iSNS service, they
    must belong to a discovery domain.
   </para>

   <important>
    <para>
     The SNS service must be installed and running to configure iSNS
     discovery domains. For information, see
     <xref linkend="bi0bdwd" xrefstyle="SectTitleOnPage"/>.
    </para>
   </important>

   <sect2 id="sec.isns.ddcreate">
    <title>Creating iSNS Discovery Domains</title>
    <para>
     A default discovery domain named <guimenu>default DD</guimenu> is
     automatically created when you install the iSNS service. The existing
     iSCSI targets and initiators that have been configured to use iSNS are
     automatically added to the default discovery domain.
    </para>
    <para>
     To create a new discovery domain:
    </para>
    <procedure id="bgchyh5">
     <step id="bgchyh6">
      <para>
       Start &yast; and under <guimenu>Network Services</guimenu>, select
       <guimenu>iSNS Server</guimenu>.
      </para>
     </step>
     <step id="bgchyh7">
      <para>
       Click the <guimenu>Discovery Domains</guimenu> tab.
      </para>
      <para>
       The <guimenu>Discovery Domains</guimenu> area lists all discovery
       domains. You can create new discovery domains, or delete existing
       ones.Deleting a domain removes the members from the domain, but it
       does not delete the iSCSI node members.
      </para>
      <para>
       The <guimenu>Discovery Domain Members</guimenu> area lists all iSCSI
       nodes assigned to a selected discovery domain. Selecting a different
       discovery domain refreshes the list with members from that discovery
       domain. You can add and delete iSCSI nodes from a selected discovery
       domain. Deleting an iSCSI node removes it from the domain, but it
       does not delete the iSCSI node.
      </para>
      <para>
       Creating an iSCSI node allows a node that is not yet registered to be
       added as a member of the discovery domain. When the iSCSI initiator
       or target registers this node, then it becomes part of this domain.
      </para>
      <para role="intro">
       When an iSCSI initiator performs a discovery request, the iSNS
       service returns all iSCSI node targets that are members of the same
       discovery domain.
      </para>
      <informalfigure pgwide="0">
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="isns_discdomains_a.png" width="307pt" format="PNG"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="isns_discdomains_a.png" width="307pt" format="PNG"/>
        </imageobject>
       </mediaobject>
      </informalfigure>
     </step>
     <step id="bi0cku8">
      <para>
       Click the <guimenu>Create Discovery Domain</guimenu> button.
      </para>
      <para>
       You can also select an existing discovery domain and click the
       <guimenu>Delete</guimenu> button to remove that discovery domain.
      </para>
     </step>
     <step id="bgchyh8">
      <para>
       Specify the name of the discovery domain you are creating, then click
       <guimenu>OK</guimenu>.
      </para>
     </step>
     <step id="bi71u1v">
      <para>
       Continue with
       <xref linkend="sec.isns.ddscreate" xrefstyle="SectTitleOnPage"/>.
      </para>
     </step>
    </procedure>
   </sect2>

   <sect2 id="sec.isns.ddscreate">
    <title>Creating iSNS Discovery Domain Sets</title>
    <para>
     Discovery domains must belong to a discovery domain set. You can create
     a discovery domain and add nodes to that discovery domain, but it is
     not active and the iSNS service does not function unless you add the
     discovery domain to a discovery domain set. A default discovery domain
     set named <guimenu>default DDS</guimenu> is automatically created when
     you install iSNS and the default discovery domain is automatically
     added to that domain set.
    </para>
    <para>
     To create a discovery domain set:
    </para>
    <procedure id="bgchyh9">
     <step id="bgchyha">
      <para>
       Start &yast; and under <guimenu>Network Services</guimenu>, select
       <guimenu>iSNS Server</guimenu>.
      </para>
     </step>
     <step id="bi0cs2c">
      <para>
       Click the <guimenu>Discovery Domains Sets</guimenu> tab.
      </para>
      <para>
       The <guimenu>Discovery Domain Sets</guimenu> area lists all of the
       discover domain sets. A discovery domain must be a member of a
       discovery domain set in order to be active.
      </para>
      <para>
       In an iSNS database, a discovery domain set contains discovery
       domains, which in turn contains iSCSI node members.
      </para>
      <para>
       The <guimenu>Discovery Domain Set Members</guimenu> area lists all
       discovery domains that are assigned to a selected discovery domain
       set. Selecting a different discovery domain set refreshes the list
       with members from that discovery domain set. You can add and delete
       discovery domains from a selected discovery domain set. Removing a
       discovery domain removes it from the domain set, but it does not
       delete the discovery domain.
      </para>
      <para>
       Adding an discovery domain to a set allows a not yet registered iSNS
       discovery domain to be added as a member of the discovery domain set.
      </para>
      <informalfigure pgwide="0">
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="isns_discdomainsets_a.png" width="422pt" format="PNG"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="isns_discdomainsets_a.png" width="422pt" format="PNG"/>
        </imageobject>
       </mediaobject>
      </informalfigure>
     </step>
     <step id="bgchyhb">
      <para>
       Click the <guimenu>Create Discovery Domain Set</guimenu> button.
      </para>
      <para>
       You can also select an existing discovery domain set and click the
       <guimenu>Delete</guimenu> button to remove that discovery domain set.
      </para>
     </step>
     <step id="bgchyhc">
      <para>
       Specify the name of the discovery domain set you are creating, then
       click <guimenu>OK</guimenu>.
      </para>
     </step>
     <step id="bi71u8j">
      <para>
       Continue with
       <xref linkend="sec.isns.ddadd" xrefstyle="SectTitleOnPage"/>.
      </para>
     </step>
    </procedure>
   </sect2>

   <sect2 id="sec.isns.ddadd">
    <title>Adding iSCSI Nodes to a Discovery Domain</title>
    <procedure id="bgchyhd">
     <step id="bgchyhe">
      <para>
       Start &yast; and under <guimenu>Network Services</guimenu>, select
       <guimenu>iSNS Server</guimenu>.
      </para>
     </step>
     <step id="bi0csq8">
      <para>
       Click the <guimenu>iSCSI Nodes</guimenu> tab.
      </para>
      <informalfigure pgwide="0">
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="isns_iscsinodes_a.png" width="422pt" format="PNG"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="isns_iscsinodes_a.png" width="422pt" format="PNG"/>
        </imageobject>
       </mediaobject>
      </informalfigure>
     </step>
     <step id="bgchyhf">
      <para>
       Review the list of nodes to ensure that the iSCSI targets and
       initiators that you want to use the iSNS service are listed.
      </para>
      <para>
       If an iSCSI target or initiator is not listed, you might need to
       restart the iSCSI service on the node. You can do this by running the
       <command>sudo systemctl restart open-iscsi.service</command> command
       to restart an initiator or the <command>sudo systemctl restart
       iscsitarget.service</command> command to restart a target.
      </para>
      <para>
       You can select an iSCSI node and click the <guimenu>Delete</guimenu>
       button to remove that node from the iSNS database. This is useful if
       you are no longer using an iSCSI node or have renamed it.
      </para>
      <para>
       The iSCSI node is automatically added to the list (iSNS database)
       again when you restart the iSCSI service or reboot the server unless
       you remove or comment out the iSNS portion of the iSCSI configuration
       file.
      </para>
     </step>
     <step id="bgchyhg">
      <para>
       Click the <guimenu>Discovery Domains</guimenu> tab, select the
       desired discovery domain, then click the <guimenu>Display
       Members</guimenu> button.
      </para>
     </step>
     <step id="bgchyhh">
      <para>
       Click <guimenu>Add existing iSCSI Node</guimenu>, select the node you
       want to add to the domain, then click <guimenu>Add Node</guimenu>.
      </para>
     </step>
     <step id="bgchyhi">
      <para>
       Repeat <xref linkend="bgchyho" xrefstyle="StepXRef"/> for as many
       nodes as you want to add to the discovery domain, then click
       <guimenu>Done</guimenu> when you are finished adding nodes.
      </para>
      <para>
       An iSCSI node can belong to more than one discovery domain.
      </para>
     </step>
     <step id="bi71uie">
      <para>
       Continue with
       <xref linkend="sec.isns.ddsadd" xrefstyle="SectTitleOnPage"/>.
      </para>
     </step>
    </procedure>
   </sect2>

   <sect2 id="sec.isns.ddsadd">
    <title>Adding Discovery Domains to a Discovery Domain Set</title>
    <procedure id="bgchyhj">
     <step id="bgchyhk">
      <para>
       Start &yast; and under <guimenu>Network Services</guimenu>, select
       <guimenu>iSNS Server</guimenu>.
      </para>
     </step>
     <step id="bgchyhl">
      <para>
       Click the <guimenu>Discovery Domains Set</guimenu> tab.
      </para>
     </step>
     <step id="bgchyhm">
      <para>
       Select <guimenu>Create Discovery Domain Set</guimenu> to add a new
       set to the list of discovery domain sets.
      </para>
     </step>
     <step id="bgchyhn">
      <para>
       Choose a discovery domain set to modify.
      </para>
     </step>
     <step id="bgchyho">
      <para>
       Click <guimenu>Add Discovery Domain</guimenu>, select the discovery
       domain you want to add to the discovery domain set, then click
       <guimenu>Add Discovery Domain</guimenu>.
      </para>
     </step>
     <step id="bgchyhp">
      <para>
       Repeat the last step for as many discovery domains as you want to add
       to the discovery domain set, then click <guimenu>Done</guimenu>.
      </para>
      <para>
       A discovery domain can belong to more than one discovery domain set.
      </para>
     </step>
    </procedure>
   </sect2>

<!-- this is done in the iSCSI chapter.
  <sect2 id="bcn9uwp">
   <title>Setting Up the iSCSI Initiator to Use the iSNS Server</title>
   <para>
    Do the following for each iSCSI initiator server that should use the
    iSNS server:
   </para>
   <procedure id="bcn9vbi">
    <step id="bcn9vbj" performance="required">
     <para>
      At the console on the iSCSI initiator server, log in as the
      &rootuser; user, then open a terminal console.
     </para>
    </step>
    <step id="bcn9vqt" performance="required">
     <para>
      At the terminal console prompt, enter
     </para>
<screen>
scsiadm - -mode discovery - -type isns - -portal <replaceable>isns_server_ip_addr</replaceable>
</screen>
     <para>
      Replace <replaceable>isns_server_ip_addr</replaceable> with the IP
      address of the iSNS server. For example, if the IP address of the
      iSNS server is 10.10.10.200, enter
     </para>
     <screen>
scsiadm - -mode discovery - -type isns - -portal 10.10.10.200
</screen>
    </step>
   </procedure>
  </sect2> -->
  </sect1>
  <sect1 id="bi0bdwd">
   <title>Starting iSNS</title>

   <para>
    iSNS must be started at the server where you install it. Enter the
    following command at a terminal console:
   </para>

<screen>
 <command>sudo systemctl start isns.service</command> 
</screen>

   <para>
    You can also use the <command>stop</command>, <command>status</command>,
    and <command>restart</command> options with iSNS.
   </para>

   <para>
    iSNS can also be configured to start automatically each time the server
    is rebooted:
   </para>

   <procedure id="bgchyh1">
    <step id="bgchyh2">
     <para>
      Start &yast; and under <guimenu>Network Services</guimenu>, select
      <guimenu>iSNS Server</guimenu>.
     </para>
    </step>
    <step id="bgchyh3">
     <para>
      With the <guimenu>Service</guimenu> tab selected, specify the IP
      address of your iSNS server, then click <guimenu>Save
      Address</guimenu>.
     </para>
    </step>
    <step id="bgchyh4">
     <para>
      In the <guimenu>Service Start</guimenu> section of the screen, select
      <guimenu>When Booting</guimenu>.
     </para>
     <para>
      You can also choose to start the iSNS server manually. You must then
      use <command>sudo systemctl start isns.service</command> to start the
      service each time the server is restarted.
     </para>
    </step>
   </procedure>
  </sect1>
  <sect1 id="bi0cewc">
   <title>Stopping iSNS</title>

   <para>
    iSNS must be stopped at the server where it is running. Enter the
    following command at a terminal console:
   </para>

<screen>
<command>sudo systemctl stop isns.service</command> 
</screen>
  </sect1>
  <sect1 id="bgchyhq">
   <title>For More Information</title>

   <para>
    For information, see the
    <ulink url="http://sourceforge.net/projects/linuxisns/"><citetitle>Linux
    iSNS for iSCSI project</citetitle></ulink>. The electronic mailing list
    for this project is
    <ulink url="http://sourceforge.net/mailarchive/forum.php?forum_name=linuxisns-discussion"><citetitle>Linux
    iSNS - Discussion</citetitle></ulink>.
   </para>

   <para>
    General information about iSNS is available in
    <ulink url="http://www.ietf.org/rfc/rfc4171"><citetitle>RFC 4171:
    Internet Storage Name Service</citetitle></ulink>.
   </para>
  </sect1>
 </chapter>
