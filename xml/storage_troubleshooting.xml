<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd" [
  <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>
<chapter id="trbl" lang="en">
  <title>Troubleshooting Storage Issues</title>
  <para>
   This section describes how to work around known issues for devices,
   software RAIDs, multipath I/O, and volumes.
  </para>
  <itemizedlist role="subtoc">
   <listitem>
    <para>
     <xref linkend="trblmpioboot" xrefstyle="SectTitleOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="trbl_btrfs_volfull" xrefstyle="SectTitleOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="bpjpklm" xrefstyle="SectTitleOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="bpjpgil" xrefstyle="SectTitleOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="bpjphka" xrefstyle="SectTitleOnPage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="ts_iscsi_lio" xrefstyle="SectTitleOnPage"/>
    </para>
   </listitem>
  </itemizedlist>
  <sect1 id="trblmpioboot">
   <title>Is DM-MPIO Available for the Boot Partition?</title>

   <para>
    Device Mapper Multipath I/O (DM-MPIO) is supported for the boot
    partition, beginning in &productname; 10 Support Pack 1.
    For information, see
    <xref linkend="mpioroot" xrefstyle="SectTitleOnPage"/>.
   </para>
  </sect1>
  <sect1 id="trbl_btrfs_volfull">
   <title>Btrfs Error: No space is left on device</title>

   <para>
    The root (<filename>/</filename>) partition using the Btrfs file system
    stops accepting data. You receive the error <quote><literal>No space
    left on device</literal></quote>.
   </para>

   <para>
    See the following sections for information about possible causes and
    prevention of this issue.
   </para>

   <sect2 id="b15tk0m4">
    <title>Disk Space Consumed by Snapper Snapshots</title>
    <para>
     If Snapper is running for the Btrfs file system, the <quote><literal>No
     space left on device</literal></quote> problem is typically caused by
     having too much data stored as snapshots on your system.
    </para>
    <para>
     You can remove some snapshots from Snapper, however, the snapshots are
     not deleted immediately and might not free up as much space as you
     need.
    </para>
    <para>
     To delete files from Snapper:
    </para>
    <procedure id="b15q34ft">
     <step id="b15tk0m5">
      <para>
       Log in as the &rootuser; user, then open a
       terminal console.
      </para>
     </step>
     <step id="b15tk9ch">
      <para>
       Gain back enough space for the system to come up.
      </para>
      <substeps>
       <step id="b15tk0m6">
        <para>
         At the command prompt, enter
        </para>
<screen>
btrfs filesystem show
</screen>
<screen>
Label: none uuid: 40123456-cb2c-4678-8b3d-d014d1c78c78
 Total devices 1 FS bytes used 20.00GB
 devid 1 size 20.00GB used 20.00GB path /dev/sda3
</screen>
       </step>
       <step id="b15q34fu">
        <para>
         Enter
        </para>
<screen>
btrfs fi balance start &lt;<replaceable>/mountpoint</replaceable>&gt; -dusage=5
</screen>
        <para>
         This command attempts to relocate data in empty or near-empty data
         chunks, allowing the space to be reclaimed and reassigned to
         metadata. This can take awhile (many hours for 1 TB) although the
         system is otherwise usable during this time.
        </para>
       </step>
      </substeps>
     </step>
     <step id="b15q34fv">
      <para>
       List the snapshots in Snapper. Enter
      </para>
<screen>
snapper -c root list
</screen>
     </step>
     <step id="b15q34fw">
      <para role="intro">
       Delete one or more snapshots from Snapper. Enter
      </para>
<screen>
snapper -c root delete #
</screen>
      <para>
       Ensure that you delete the oldest snapshots first. The older a
       snapshot is, the more disk space it occupies.
      </para>
     </step>
    </procedure>
    <para>
     To help prevent this problem, you can change the Snapper cleanup
     defaults to be more aggressive in the
     <filename>/etc/snapper/configs/root</filename> configuration file, or
     for other mount points. Snapper provides three algorithms to clean up
     old snapshots. The algorithms are executed in a daily cron-job. The
     cleanup frequency is defined in the Snapper configuration for the mount
     point. Lower the TIMELINE_LIMIT parameters for daily, monthly, and
     yearly to reduce how long and the number of snapshots to be retained.
     For information, see <xref linkend="sec.snapper.config"/>
    </para>
    <para>
     If you use Snapper with Btrfs on the file system disk, it is advisable
     to reserve twice the amount of disk space than the standard storage
     proposal. The &yast; Partitioner automatically proposes twice the
     standard disk space in the Btrfs storage proposal for the root file
     system.
    </para>
   </sect2>

   <sect2 id="b15tk0m7">
    <title>Disk Space Consumed by Log, Crash, and Cache Files</title>
    <para>
     If the system disk is filling up with data, you can try deleting files
     from <filename>/var/log</filename>, <filename>/var/crash</filename>,
     and <filename>/var/cache</filename>.
    </para>
    <para>
     The Btrfs &rootuser; file system subvolumes
     <filename>/var/log</filename>, <filename>/var/crash</filename> and
     <filename>/var/cache</filename> can use all of the available disk space
     during normal operation, and cause a system malfunction. To help avoid
     this situation, &productname; offers Btrfs quota support for
     subvolumes. See the <filename>btrfs(8)</filename> manual page for more
     details.
    </para>
   </sect2>
  </sect1>
  <sect1 id="bpjpklm">
   <title>Issues for Multipath I/O</title>

   <para>
    See <xref linkend="bpjpirk" xrefstyle="SectTitleOnPage"/>.
   </para>
  </sect1>
  <sect1 id="bpjpgil">
   <title>Issues for Software RAIDs</title>

   <para>
    See <xref linkend="bgchysg" xrefstyle="AppTitleOnPage"/>.
   </para>
  </sect1>
  <sect1 id="bpjphka">
   <title>Issues for iSCSI</title>

   <para>
    See
    <xref linkend="sec_inst_system_iscsi_ts" xrefstyle="SectTitleOnPage"/>.
   </para>
  </sect1>
  <sect1 id="ts_iscsi_lio">
   <title>Issues for iSCSI LIO Target</title>

   <para>
    See <xref linkend="b13g8i2g" xrefstyle="SectTitleOnPage"/>.
   </para>
  </sect1>
 </chapter>
