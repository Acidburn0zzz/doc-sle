<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="depl_smt.xml" id="cha.smt">
 <title>Gestion des abonnements</title>

 <para>
  Tout ordinateur qui exécute SUSE Linux Enterprise Server <phrase role="productname"><phrase os="sles;sled;slerte">12</phrase></phrase> ou SUSE Linux Enterprise Desktop <phrase role="productname"><phrase os="sles;sled;slerte">12</phrase></phrase> peut être configuré de façon à s'enregistrer auprès d'un serveur Subscription Management Tool (SMT) local afin de télécharger des mises à jour logicielles au lieu de communiquer directement avec SUSE Customer Center et les serveurs NU. Pour utiliser un serveur SMT en vue de l'enregistrement du client et en tant que source de mise à jour locale, vous devez commencer par configurer le serveur SMT de votre réseau. Le logiciel du serveur SMT est distribué sous forme de produit complémentaire pour SUSE Linux Enterprise Server et sa configuration est décrite dans le manuel <emphasis>Subscription Management Tool Guide</emphasis> (Guide de SMT). Il n'est pas nécessaire d'installer de produit complémentaire sur les clients à configurer en vue de leur enregistrement auprès d'un serveur SMT.
 </para>
 <para>
  Pour enregistrer un client auprès d'un serveur SMT, vous devez spécifier au client l'URL du serveur. Puisque le client et le serveur communiquent via le protocole HTTPS pendant l'enregistrement, vous devez également vous assurer que le client approuve le certificat du serveur. Si votre serveur SMT est configuré de façon à utiliser le certificat par défaut du serveur, le certificat de l'autorité de certification (AC) sera disponible sur le serveur SMT via le protocole HTTP à l'adresse <literal>http://<replaceable>FQDN</replaceable>/smt.crt</literal>. Dans ce cas, vous ne devez pas vous préoccuper du certificat : le processus d'enregistrement téléchargera automatiquement le certificat AC à partir de cet emplacement, sauf configuration contraire. Vous devez entrer un chemin d'accès au certificat AC du serveur si le certificat a été émis par une autorité de certification externe.
 </para>

 <para>
  Il existe plusieurs façons de fournir ces informations et de configurer la machine du client en vue de l'utilisation de SMT. La première consiste à fournir les informations requises via les paramètres du kernel au moment du démarrage. La seconde consiste à configurer les clients en utilisant un profil AutoYaST. Il existe également un script distribué avec Subscription Management Tool, <command>clientSetup4SMT.sh</command>, qui peut être exécuté sur un client afin d'enregistrer ce dernier auprès d'un serveur SMT spécifié. Ces méthodes sont décrites dans les sections suivantes :
 </para>
 <sect1 id="smt.client.parameters">
  <title>Utilisation des paramètres du kernel pour accéder à un serveur SMT</title>

  <para>
   Tout client peut être configuré de façon à utiliser SMT en fournissant les paramètres du kernel <literal>regurl</literal> et <literal>regcert</literal> pendant le démarrage de la machine. Le premier paramètre est obligatoire et le second est facultatif.
  </para>

  <variablelist>
   <varlistentry>
    <term>regurl</term>
    <listitem>
     <para>
      URL du serveur SMT. L'URL doit être au format suivant : <literal>https://<replaceable>FQDN</replaceable></literal>, <replaceable>FQDN</replaceable> représentant le nom d'hôte complet du serveur SMT. Ce nom doit être identique au nom de domaine complet du certificat du serveur utilisé sur le serveur SMT. Exemple :
     </para>
<screen>regurl=https://smt.example.com</screen>
    </listitem>
   </varlistentry>
  </variablelist>

  <warning>
   <title>attention aux fautes de frappe</title>
   <para>
    Assurez-vous d'entrer des valeurs correctes. Si <literal>regurl</literal> n'a pas été saisi correctement, il sera impossible d'enregistrer la source de mise à jour.
   </para>
  </warning>

  <warning>
   <title>modification du certificat du serveur SMT</title>
   <para>
    Si le serveur SMT obtient un nouveau certificat auprès d'une nouvelle autorité de certification non approuvée, les clients devront récupérer le fichier du certificat de la nouvelle autorité de certification. Cette étape est automatique dans le cadre du processus d'enregistrement, mais uniquement si une URL a été utilisée au moment de l'installation pour récupérer le certificat ou si le paramètre <literal>regcert</literal> a été ignoré, entraînant ainsi l'utilisation de l'URL par défaut. Si le certificat a été chargé à l'aide d'une autre méthode (par exemple, à l'aide du chemin local), le certificat AC n'est pas mis à jour.
   </para>
  </warning>
 </sect1>
 <sect1 id="smt.client.autoyast">
  <title>Configuration des clients à l'aide d'un profil AutoYaST</title>

  <para>
   Les clients peuvent être configurés de façon à s'enregistrer auprès du serveur SMT via un profil AutoYaST. Pour obtenir des informations d'ordre général sur la création des profils AutoYaST et la préparation de l'installation automatique, reportez-vous au <xref linkend="cha.deployment.autoinst"/>. Dans cette section, seule la configuration spécifique à SMT est décrite.
  </para>

  <para>
   Pour configurer les données spécifiques à SMT à l'aide de AutoYaST, procédez comme suit :
  </para>

  <procedure>
   <step performance="required">
    <para>
     Connectez-vous en tant qu'utilisateur <systemitem class="username">root</systemitem>, démarrez YaST et sélectionnez <menuchoice> <guimenu>Divers</guimenu> <guimenu>Installation automatique</guimenu> </menuchoice> pour ouvrir l'interface client graphique AutoYaST.
    </para>
    <para>
     Vous pouvez ouvrir l'interface client graphique AutoYaST à partir d'une ligne de commande en exécutant <command>yast2 autoyast</command>.

    </para>
   </step>
   <step performance="required">
    <para>
     Vous pouvez ouvrir un profil existant en cliquant sur <menuchoice><guimenu>Fichier</guimenu><guimenu>Ouvrir</guimenu></menuchoice>, créer un profil basé sur la configuration système actuelle en cliquant sur <menuchoice><guimenu>Outils</guimenu><guimenu>Créer un profil de référence</guimenu></menuchoice> ou utiliser un profil vide.
    </para>
   </step>
   <step performance="required">
    <para>
     Sélectionnez <menuchoice><guimenu>Support</guimenu><guimenu>Configuration de SUSE Customer Center</guimenu></menuchoice>. Un aperçu de la configuration actuelle s'affiche.
    </para>
   </step>
   <step performance="required">
    <para>
     Cliquez sur <guimenu>Modifier</guimenu>.
    </para>
   </step>
   <step performance="required">

    <para>
     Pour effectuer automatiquement l'enregistrement durant l'installation, sélectionnez <guimenu>Exécuter l'enregistrement du produit</guimenu>.  
    </para>
   </step>
   <step performance="required">
    <para>
     Définissez l'URL du <guimenu>serveur SMT</guimenu> et éventuellement l'emplacement du <guimenu>certificat SMT</guimenu>. Les valeurs possibles sont les mêmes que pour le paramètre du kernel <literal>regurl</literal>. Les valeurs possibles sont les mêmes que pour les paramètres du kernel <literal>regurl</literal> et <literal>regcert</literal> (voir <xref linkend="smt.client.parameters"/>). La seule exception réside dans le fait que la valeur <literal>ask</literal> du paramètre <literal>regcert</literal> ne fonctionne pas dans AutoYaST, car elle nécessite une intervention de l'utilisateur. Si vous l'utilisez, le processus d'enregistrement sera ignoré.
    </para>
    <para>Si vous suivez le processus d'enregistrement, YaST peut utiliser des produits complémentaires (extensions ou modules) provenant d'un serveur d'enregistrement SUSE Customer Center. Grâce au SUSE Customer Center, vous pouvez enregistrer et installer de nouveaux produits, tels que le SDK SUSE, la haute disponibilité, l'extension GEO Clustering for SUSE Linux Enterprise High Availability et bien d'autres, directement disponibles auprès de votre SUSE Customer Center. Le SUSE Customer Center permet même d'installer le niveau de correctif le plus récent.
    </para>
   </step>
   <step performance="required">
    <para>
     Exécutez toutes les autres configurations requises pour les systèmes à déployer.
    </para>
   </step>
   <step performance="required">
    <para>
     Sélectionnez <menuchoice> <guimenu>Fichier</guimenu> <guimenu>Enregistrer sous</guimenu> </menuchoice>, puis attribuez un nom de fichier au profil, tel que <filename>autoinst.xml</filename>.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="smt.client.clientsetupscript">
  <title>Configuration des clients via le script clientSetup4SMT.sh</title>

  <para>
   Le script <command>/usr/share/doc/packages/smt/clientSetup4SMT.sh</command> est fourni avec SMT. Il permet de configurer une machine cliente afin qu'elle utilise un serveur SMT ou de la reconfigurer pour qu'elle utilise un autre serveur SMT.
  </para>

  <para>
   Pour configurer une machine cliente afin qu'elle utilise SMT avec le script <command>clientSetup4SMT.sh</command>, procédez comme suit :
  </para>

  <procedure>
   <step performance="required">
    <para>
     Copiez le script <filename>/usr/share/doc/packages/smt/clientSetup4SMT.sh</filename> à partir de votre serveur SMT sur la machine cliente.
    </para>
   </step>
   <step performance="required">
    <para>
     Connectez-vous en tant qu'utilisateur <systemitem class="username">root</systemitem> et exécutez le script sur la machine cliente. Le script peut s'exécuter de deux façons :
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       Le nom de script est suivi par l'URL d'enregistrement :
      </para>
<screen>./clientSetup4SMT.sh <replaceable>registration_URL</replaceable></screen>
      <para>
       par exemple :
      </para>
<screen>./clientSetup4SMT.sh  https://smt.example.com/center/regsvc</screen>
     </listitem>
     <listitem>
      <para>
       Le nom du script est suivi de l'option <option>--host</option>, puis du nom d'hôte du serveur SMT :
      </para>
<screen>./clientSetup4SMT.sh  --host <replaceable>server_hostname</replaceable></screen>
      <para>
       par exemple :
      </para>
<screen>./clientSetup4SMT.sh --host  smt.example.com</screen>
     </listitem>
    </itemizedlist>
    <para>
     Le script télécharge le certificat AC du serveur. 
    </para>
    <important>
     <title>paramètre <option>--host</option></title>
     <para>
      Le nom d'hôte devant être fourni avec le paramètre <option>--host</option> doit être identique à celui pour lequel le certificat a été émis. De plus, si le nom indiqué dans le certificat est le nom de domaine complet (ajouter smt.exemple.com, par exemple), il doit être saisi comme tel. La saisie du nom <quote>court</quote> (smt) entraînera l'échec du script <command>clientSetup4SMT.sh</command>.
     </para>
    </important>
   </step>
   <step performance="required">
    <para>
     Acceptez le certificat AC du serveur en appuyant sur <keycap>y</keycap>.
    </para>
   </step>
   <step performance="required">
    <para>
     Le script exécute toutes les modifications requises sur le client. Si vous le souhaitez, l'enregistrement proprement dit peut être effectué par le script.
    </para>
   </step>
   <step performance="required">
    <para>
     
     Effectuez un enregistrement en exécutant <command>SUSEConnect</command> sur le client.
    </para>
   </step>
  </procedure>




 </sect1>
 <sect1 id="sec.smt.register">
  <title>Enregistrement des clients dans un environnement de test SMT</title>

  

  <para>
   Pour configurer l'enregistrement d'un client dans un environnement de test au lieu d'un environnement de production, utilisez <command>SUSEConnect</command> sur la machine du client :
  </para>

<screen>SUSEConnect -r <replaceable>REG_CODE</replaceable></screen>

  <para>
   Remplacez <replaceable>REG_CODE</replaceable> par le code d'enregistrement de votre produit. Vous le trouverez sur le site <ulink url="http://scc.suse.com"/>.
  </para>



  <para>
   Pour plus d'informations sur l'utilisation de SMT dans un environnement de test, reportez-vous au manuel <emphasis>Subscription Management Tool Guide</emphasis> (Guide de SMT).
  </para>
 </sect1>
</chapter>
