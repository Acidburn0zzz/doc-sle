<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="net_nfs.xml" id="cha.nfs">
 <title>NFS共有ファイルシステム</title>
<indexterm> <primary>NFS</primary> </indexterm> <indexterm> <primary>ネットワークファイルシステム</primary> <see>NFS</see> </indexterm>
 <abstract>
  <para>
   ネットワーク上でファイルシステムを分散して共有することは、企業環境では一般的なタスクです。十分に実績のあるネットワークファイルシステム (<emphasis>NFS</emphasis>)は、<emphasis>NIS </emphasis>(Yellow Pagesプロトコル)と連携して機能します。<emphasis>LDAP</emphasis>と連携して機能し、Kerberosも使用できるより安全なプロトコルについては、<emphasis>NFSv4</emphasis>をチェックしてください。pNFSとの組み合わせで、パフォーマンスのボトルネックをなくすことができます。
  </para>

  <para>
   NFSをNISと連携して使用すると、ネットワークをユーザに対して透過的にすることができます。NFSでは、ネットワーク経由で任意のファイルシステムを分散できます。適切なセットアップを行えば、現在どの端末を使用しているかに係わりなく、常に同じ環境で作業できます。
  </para>
 </abstract>
 
 <sect1 id="sec.nfs.term">
  <title>用語集</title>

  <para>
   以下の用語は、YaSTモジュールで使用されています。
  </para>



  <variablelist>
   <varlistentry>
    <term>エクスポート</term>
    <listitem>
     <para>
      NFSサーバによって<emphasis>エクスポート</emphasis>され、クライアントがシステムに統合できるディレクトリ。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSクライアント</term>
    <listitem>
     <para>
      NFSクライアントは、ネットワークファイルシステムプロトコルを介してNFSサーバからのNFSサービスを使用するシステムです。TCP/IPプロトコルはLinuxカーネルにすでに統合されており、追加ソフトウェアをインストールする必要はありません。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSサーバ</term>
    <listitem>
     <para>
      NFSサーバは、NFSサービスをクライアントに提供します。<systemitem class="daemon">nfsd</systemitem>(ワーカー)、<systemitem class="daemon">idmapd </systemitem>(IDへのユーザおよびグループ名のマッピングと、その逆のマッピング)、<systemitem class="daemon">statd</systemitem>(ファイルのロック)、および<systemitem class="daemon">mountd</systemitem> (マウント要求)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv3</term>
    <listitem>
     <para>
      NFSv3はバージョン3の実装で、クライアント認証をサポートする<quote>古い</quote>ステートレスなNFSです。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFSv4</term>
    <listitem>
     <para>
      NFSv4は、Kerberosによるセキュアなユーザ認証をサポートする新しいバージョン4の実装です。NFSv4で必要なポートは1つのみであるため、NFSv3よりもファイアウォール環境に適しています。
     </para>
     <para>
      プロトコルは<ulink url="http://tools.ietf.org/html/rfc3530"/>で指定されています。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>pNFS</term>
    <listitem>
     <para>
      パラレル NFS。NFSv4のプロトコル拡張。 任意のpNFSクライアントは、NFSサーバ上のデータに直接アクセスできます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 os="sled" id="sec.nfs.installation-sled">


  <title>NFSサーバのインストール</title>

  <para>
   NFSサーバのインストールと設定については、SUSE Linux Enterprise Serverのドキュメントを参照してください。
  </para>
 </sect1>

 
 
 <sect1 id="sec.nfs.configuring-nfs-clients">
  <title>クライアントの設定</title>

  <para>
   ホストをNFSクライアントとして設定する場合、他のソフトウェアをインストールする必要はありません。必要なすべてのパッケージは、デフォルトでインストールされます。
  </para>

  <sect2 id="sec.nfs.import-yast2">
   <title>YaSTによるファイルシステムのインポート</title><indexterm> <primary>NFS</primary> <secondary>クライアント</secondary> </indexterm>
   <para>
    認証されたユーザは、YaST NFSクライアントモジュールを使用して、NFSディレクトリをNFSサーバからローカルファイルツリーにマウントできます。次の手順に従います。
   </para>
   <procedure id="pro.nfs.import-yast2">
    <title>NFSディレクトリのインポート</title>
    <step performance="required">
     <para>
      YaST NFSクライアントモジュールを起動します。
     </para>
    </step>

    <step performance="required">
     <para>
      <guimenu>NFS共有</guimenu>タブで<guimenu>追加</guimenu>をクリックします。NFSサーバのホスト名、インポートするディレクトリ、およびこのディレクトリをローカルでマウントするマウントポイントを入力します。
     </para>
    </step>


    <step performance="required">
     <para>
      NFSv4を使用する場合は、<guimenu>NFS設定</guimenu>タブで<guimenu>NFSv4を有効にする</guimenu>を選択します。また、<guimenu>NFSv4ドメイン名</guimenu>に、NFSv4サーバが使用する値と同じ値が入力されている必要があります。デフォルトドメインは、<literal>localdomain</literal>です。
     </para>
    </step>
    <step performance="required">
     <para>
      NFSでKerberos認証を使用するには、GSSセキュリティを有効にする必要があります。<guimenu>GSSセキュリティを有効にする</guimenu>を選択します。
     </para>
    </step>
    <step performance="required">
     <para>
      ファイアウォールを使用しており、リモートコンピュータのサービスにアクセスを許可する場合は、<guimenu>NFS設定</guimenu>タブで<guimenu>ファイアウォールでポートを開く</guimenu>をオンにします。チェックボックスの下には、ファイアウォールのステータスが表示されます。
     </para>
    </step>

    <step performance="required">
     <para>
      <guimenu>OK</guimenu>をクリックして変更内容を保存します。
     </para>
    </step>
   </procedure>
   <para>
    設定は<filename>/etc/fstab</filename>に書かれ、指定されたファイルシステムがマウントされます。後でYaST設定クライアントを起動した時に、このファイルから既存の設定が取得されます。
   </para>

  </sect2>

  <sect2 id="sec.nfs.import">
   <title>ファイルシステムの手動インポート</title>
<indexterm> <primary>NFS</primary> <secondary>インポート</secondary> </indexterm> <indexterm> <primary>NFS</primary> <secondary>マウント</secondary> </indexterm>

   <para>
    NFSサーバからファイルシステムを手動でインポートするには、RPCポートマッパーが実行していることが前提条件です。RPCポートマッパーを適切に起動するのは<option>nfs.service</option>です。そのため、<systemitem class="username">root</systemitem>として「<command>systemctl start nfs.service</command>」を入力し、RPCポートマッパーを起動します。次に、<command>mount</command>を使用して、ローカルパーティションと同様に、リモートファイルシステムをファイルシステムにマウントできます。
   </para>
<screen>mount <replaceable>host</replaceable>:<replaceable>remote-path</replaceable><replaceable>local-path</replaceable></screen>
   <para>
    たとえば、<systemitem>nfs.example.com</systemitem>マシンからユーザディレクトリをインポートするには、次の構文を使用します。
   </para>
<screen>mount nfs.example.com:/home /home</screen>
   <sect3 id="sec.nfs.automount">
    <title>自動マウントサービスの使用</title>
    <para>
     autofsデーモンを使用して、リモートファイルシステムを自動的にマウントすることができます。<filename>/etc/auto.master</filename>ファイルに次のエントリを追加します。
    </para>
<screen>/nfsmounts /etc/auto.nfs</screen>
    <para>
     これで、<filename>/nfsmounts</filename>ディレクトリがクライアント上のすべてのNFSマウントのルートディレクトリの役割を果たすようになります(<filename>auto.nfs</filename>ファイルが正しく設定されている場合)。ここでは、<filename>auto.nfs</filename>という名前を使用しましたが、任意の名前を選択することができます。<filename>auto.nfs</filename>で、次のようにしてすべてのNFSマウントのエントリを追加します。
    </para>
<screen>localdata -fstype=nfs server1:/data
nfs4mount -fstype=nfs4 server2:/</screen>
    <para>
     <systemitem class="username">root</systemitem>として<command>systemctl start autofs.service</command> を実行して設定を有効にします。 この例で、<systemitem>server1</systemitem>の<filename>/data</filename>ディレクトリの<filename>/nfsmounts/localdata</filename>はNFSでマウントされ、<systemitem>server2</systemitem>の<filename>/nfsmounts/nfs4mount</filename>はNFSv4でマウントされます。
    </para>
    <para>
     autofsの実行中に<filename>/etc/auto.master</filename>ファイルを編集した場合、変更を反映するには、<command>systemctl restart autofs.service</command>で自動マウント機能を再起動する必要があります。
    </para>
   </sect3>
   <sect3 id="sec.nfs.fstab">
    <title><filename>/etc/fstab</filename>の手動編集</title>
    <para>
     <filename>/etc/fstab</filename>内の典型的なNFSv3マウントエントリは、次のようになります:
    </para>
<screen>nfs.example.com:/data /local/path nfs rw,noauto 0 0</screen>
    <para>
     NFSv4マウントの場合は、3番目の列で<literal>nfs</literal>の代わりに<literal>nfs4</literal>を使用します。
    </para>
<screen>nfs.example.com:/data /local/pathv4 nfs4 rw,noauto 0 0</screen>
    <para>
     <literal>noauto</literal>オプションを使用すると、起動時にファイルシステムが自動マウントされません。対応するファイルシステムを手動でマウントする場合は、マウントポイントのみを指定してmountコマンドを短くできます。
    </para>
<screen>mount /local/path</screen>
    <note>
     <para>
      ただし、<literal>noauto</literal>オプションを入力しないと、起動時に、システムのinitスクリプトによって、それらのファイルシステムがマウントされます。
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 id="sec.nfs.pnfs">
   <title>パラレルNFS(pNFS)</title>
   <para>
    NFSは、1980年代に開発された、もっとも古いプロトコルの1つです。そのため、小さなファイルを共有したい場合は、通常、NFSで十分です。しかし、大きなファイルを送信したい場合や多数のクライアントがデータにアクセスしたい場合は、NFSサーバがボトルネックとなり、システムのパフォーマンスに重大な影響を及ぼします。これは、ファイルのサイズが急速に大きくなっているのに対し、Ethernetの相対速度が追い付いていないためです。
   </para>
   <para>
    <quote>通常の</quote>NFSサーバにファイルを要求すると、サーバはファイルのメタデータを検索し、すべてのデータを収集して、ネットワークを介してクライアントに送信します。しかし、ファイルが小さくても大きくてもパフォーマンスのボトルネックが問題になります。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      小さいファイルでは、メタデータの収集に時間がかかる.
     </para>
    </listitem>
    <listitem>
     <para>
      大きいファイルでは、サーバからクライアントへのデータ送信に時間がかかる
     </para>
    </listitem>
   </itemizedlist>
   <para>
    pNFS(パラレルNFS)は、ファイルシステムメタデータをデータの場所から分離することによって、この制限を克服します。このため、pNFSには2種類のサーバが必要です。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      データ以外のすべてのトラフィックを扱う「メタデータ」<emphasis/>または<emphasis/>「制御サーバ」
     </para>
    </listitem>
    <listitem>
     <para>
      データを保持する1つ以上の<emphasis/>「ストレージサーバ」
     </para>
    </listitem>
   </itemizedlist>
   <para>
    メタデータサーバとストレージサーバによって、単一の論理NFSサーバが構成されます。クライアントが読み込みまたは書き出しを行う場合、メタデータサーバがNFSv4クライアントに対して、ファイルのチャンクにアクセスするにはどのストレージサーバを使用すればよいかを指示します。クライアントはサーバのデータに直接アクセスできます。
   </para>
   <para>
    SUSE Linux Enterpriseはクライアント側でのみpNFSをサポートします。
   </para>
   <sect3 id="sec.nfs.pnfs.yast">
    <title>YaSTを使用したpNFSクライアントの設定</title>
    <para>
     <xref linkend="pro.nfs.import-yast2"/>に従って進めます。ただし、<guimenu>pNFS (v4.1)</guimenu>チェックボックスをクリックし、オプションで<guimenu>NFSv4共有</guimenu>をクリックします。YaSTが必要な手順をすべて実行し、必要なすべてのオプションを<filename>/etc/exports</filename>ファイルに書き込みます。
     
    </para>
   </sect3>
   <sect3 id="sec.nfs.pnfs.manual">
    <title>pNFSクライアントの手動設定</title>
    <para>
     <xref linkend="sec.nfs.import"/>を参照して開始します。ほとんどの設定はNFSv4サーバによって行われます。pNFSを使用する場合に異なるのは、<option>minorversion</option>オプションおよびメタデータサーバ<replaceable>MDS_SERVER</replaceable>を<command>mount</command>コマンドに追加することだけです。
    </para>
<screen>mount -t nfs4 -o minorversion=1 <replaceable>MDS_SERVER</replaceable> <replaceable>MOUNTPOINT</replaceable></screen>
    <para>
     デバッグを支援するために、<filename>/proc</filename>ファイルシステムの値を変更します。
    </para>
<screen>echo 32767 &gt; /proc/sys/sunrpc/nfsd_debug
echo 32767 &gt; /proc/sys/sunrpc/nfs_debug</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 id="sec.nfs.info">
  <title>詳細情報</title>

  <para>
   NFSサーバとクライアントの設定情報は、<command>exports</command>、<command>nfs</command>、および<command>mount</command>のマニュアルページのほか、<filename>/usr/share/doc/packages/nfsidmap/README</filename>からも入手できます。オンラインドキュメンテーションについては、次のWebサイトを参照してください。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     詳細な技術ヘルプについては、<ulink url="http://nfs.sourceforge.net/">SourceForge</ulink>を参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     NFSでのKerberosの設定方法は、<ulink url="http://www.citi.umich.edu/projects/nfsv4/linux/krb5-setup.html">NFS Version 4 Open Source Reference Implementation</ulink>を参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     <ulink url="http://www.citi.umich.edu/projects/nfsv4/linux/faq/">Linux NFSv4</ulink>には、NFSv4に関するFAQが用意されています。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
