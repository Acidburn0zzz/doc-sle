<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_migration.xml" version="5.0" xml:id="cha.update.spmigration">
 <title>服务包迁移</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSE 提供了用于升级到新服务包的一个图形化工具和一个命令行工具。它们是几个简单的命令行工具，一个直观的图形用户界面，都支持服务包<quote>回滚</quote>，而且还具备其他更多功能。本章介绍用这些工具进行服务包迁移的逐步指南。
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>概念概述</title>

  <para>
   SUSE 会定期发布用于 SUSE Linux Enterprise 系列的新服务包。为了便于客户迁移到新的服务包并最大限度减少停机时间，SUSE 支持在系统时进行联机迁移。
  </para>

  <para>
   从 SLE 12 SP2 开始，YaST Wagon 已经由 YaST 迁移 (GUI) 和 Zypper 迁移（命令行）替代。系统支持以下功能：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     系统在首个 RPM 更新之前始终处于指定的状态
    </para>
   </listitem>
   <listitem>
    <para>
     在首个 RPM 更新之前可以取消
    </para>
   </listitem>
   <listitem>
    <para>
     如果出现错误可以轻松恢复
    </para>
   </listitem>
   <listitem>
    <para>
     通过系统工具<quote>回滚</quote>；不需要备份/恢复
    </para>
   </listitem>
   <listitem>
    <para>
     使用所有活动储存库
    </para>
   </listitem>
   <listitem>
    <para>
     可以跳过服务包
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.supported-scenarios-and-versions">
  <title>支持的软件使用场景和产品版本</title>

  <para>
   SUSE 支持以下方案（不论是联机还是脱机）：
  </para>

  <variablelist>
   <varlistentry>
    <term>联机</term>
    <listitem>
     <para>
      SUSE Customer Center (SCC)、订阅管理工具 (SMT)、SUSE Manager
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>脱机</term>
    <listitem>
     <para>
      引导 DVD、闪存盘、ISO 映像、AutoYaST、<quote>普通 RPM</quote> 和第三方工具
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   支持从以下版本迁移：
  </para>

  <variablelist>
   <varlistentry>
    <term>联机</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>脱机</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 11 SP3/SP4、SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>手动/第三方</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>服务包迁移工作流程</title>

  <para>
   服务包迁移可通过 YaST、<command>zypper</command> 或 AutoYaST 执行。
  </para>

  <para>
   在开始服务包迁移之前，系统必须在 SUSE Customer Center 中注册。不能用源自 DVD 的自建储存库来执行迁移。
  </para>

  <para>
   不论使用哪种方式，服务包迁移都包含以下步骤：
  </para>

  <orderedlist>
   <listitem>
    <para>
     在注册系统中查找可能的迁移目标。
    </para>
   </listitem>
   <listitem>
    <para>
     选择一个迁移目标。
    </para>
   </listitem>
   <listitem>
    <para>
     请求并启用新的储存库。
    </para>
   </listitem>
   <listitem>
    <para>
     运行迁移。
    </para>
   </listitem>
  </orderedlist>



  <para>
   迁移目标列表取决于您所安装和注册的产品。如果您安装的扩展没有新的 SP 可用，则无法向您提供迁移目标。
  </para>

  <para>
   主机可用的迁移目标列表将始终从 SUSE Customer Center 检索，并与安装的产品或扩展相关。
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>取消服务包迁移</title>

  <para>
   服务包迁移只能在迁移过程中的特定阶段取消：
  </para>

  <orderedlist>
   <listitem>
    <para>
     包升级过程开始之前，系统上只有极小的更改，例如服务和储存库的更改。恢复 <filename>/etc/zypp/repos.d/*</filename> 以便还原到之前的状态。
    </para>
   </listitem>
   <listitem>
    <para>
     包升级过程开始之后，可以使用 Snapper 快照（请参见<xref linkend="cha.snapper"/>）还原到之前的状态。
    </para>
   </listitem>
   <listitem>
    <para>
     选择迁移目标之后，SUSE Customer Center 更改了储存库数据。要手动还原此状态，请使用 <command>SUSEConnect</command> <option>--rollback</option>。
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>用联机迁移工具 (YaST) 迁移</title>

  <para>
   要通过 YaST 执行服务包迁移，请使用<guimenu>联机迁移</guimenu>工具。默认情况下，YaST 不会从第三方储存库安装任何包。如果某包是从第三方储存库安装的，YaST 会阻止该包替换成来自 SUSE 的相同包。
  </para>

  <note>
   <title>减少安装大小</title>
   <para>
    执行服务包迁移时，YaST 会安装所有推荐的包。特别是在自定义最小安装的情况下，这样可能会大幅增加系统的安装大小。
   </para>
   <para>
    要更改这种默认行为，只允许安装所需的包，请调整 <filename>/etc/zypp/zypp.conf</filename> 并设置以下变量：
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   这会更改所有与包相关操作的行为，例如安装增补程序或新包的行为。
  </para>

  <para>
   要开始服务包迁移，请执行以下操作：
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     运行 YaST 联机更新以获得系统的最新包更新。
    </para>
   </step>
   <step>
    <para>
     安装包
     <package>yast2-migration</package>
     及其依赖项（在 YaST 的<menuchoice><guimenu>软件</guimenu> <guimenu>软件管理</guimenu></menuchoice>下）。
    </para>
   </step>
   <step>
    <para>
     重启动 YaST；如果不重启动，新安装的模块将不会显示在控制中心中。
    </para>
   </step>
   <step>
    <para>
     在 YaST 的<menuchoice><guimenu>系统</guimenu> <guimenu>联机迁移</guimenu></menuchoice>中启动迁移。YaST 将显示可能的迁移目标和摘要。如果有多个迁移目标可用于系统，请从列表中选择一个。
    </para>
   </step>
   <step>
    <para>
     从列表中选择一个迁移目标，然后单击<guimenu>下一步</guimenu>继续。
    </para>
   </step>
   <step>
    <para>
     如果迁移工具提供更新储存库，建议单击<guimenu>是</guimenu>继续。
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark>如果“联机迁移”工具找到来自 DVD 或本地服务器的过时储存库，强烈建议您将其禁用。过时储存库来自上一个服务包。来自 SCC 或 SMT 的所有旧储存库会自动去除。
    </para>
   </step>
   <step>
    <para>
     单击<guimenu>下一步</guimenu>，查看摘要并继续迁移过程。确认<guimenu>开始更新</guimenu>。
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     成功迁移后，请重启动系统。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>使用 Zypper 迁移</title>

  <para>
   要用 Zypper 执行服务包迁移，请使用命令行工具 <command>zypper</command> <option>migration</option>。
  </para>

  <note>
   <title>减少安装大小</title>
   <para>
    执行服务包迁移时，YaST 会安装所有推荐的包。特别是在自定义最小安装的情况下，这样可能会大幅增加系统的安装大小。
   </para>
   <para>
    要更改这种默认行为，只允许安装所需的包，请调整 <filename>/etc/zypp/zypp.conf</filename> 并设置以下变量：
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   这会更改所有与包相关操作的行为，例如安装增补程序或新包的行为。要更改某次调用的 Zypper 行为，请在命令行上添加参数 <option>--no-recommends</option>。
  </para>

  <para>
   要开始服务包迁移，请执行以下操作：
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     注册 SUSE Linux Enterprise 计算机（如果尚未注册）：
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     安装最新的更新：
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     安装包
     <package>zypper-migration-plugin</package>
     及其依赖项：
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration</screen>
   </step>
   <step>
    <para>
     运行 <command>zypper</command> <option>migration</option>：
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     有关迁移过程的一些备注：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       如果有多个迁移目标可用于系统，Zypper 会让您从列表中选择一个服务包。这与跳过一个或多个服务包一样。请注意，基础产品（SLES、SLED）的联机迁移仍然只适用于在主要版本的服务包之间进行。
      </para>
     </listitem>
     <listitem>
      <para>
       默认情况下，Zypper 会使用 <option>--no-allow-vendor-change</option> 选项，以传递到 <command>zypper</command> <option>dup</option>。如果某包是从第三方储存库安装的，此选项会阻止该包替换成来自 SUSE 的相同包。
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark>如果 Zypper 找到来自 DVD 或本地服务器的过时储存库，强烈建议您将其禁用。旧的 SCC 或 SMT 储存库会自动去除。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     查看所有更改，特别是即将去除的包。键入 <literal>y</literal>（要升级的包的确切数目会根据系统的不同而变化）继续：
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     使用 <keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo> 或 <keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo> 键在外壳中滚动。
    </para>
   </step>
   <step>
    <para>
     成功迁移后，请重启动系统。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>单纯用 Zypper 迁移</title>

  <para>
   如果不能使用 YaST 迁移或 Zypper 迁移，您仍可以单纯通过 Zypper 并执行一些人工交互进行迁移。要开始服务包迁移，请执行以下操作：
  </para>

  <procedure>
   <step>
    <para>
     用旧 SUSE Linux Enterprise 储存库更新包管理工具：
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch--updatestack-only</screen>
   </step>
   <step>
    <para>
     如果系统已注册，则需要先取消注册：
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     去除旧安装源和储存库，并调整第三方储存库。
    </para>
   </step>
   <step>
    <para>
     添加新的安装源，不论是本地的还是远程的（有关占位符 <replaceable>REPOSITORY</replaceable>，请参考<xref linkend="tab.update.nmm.repositories.sp2"/>）：
    </para>
<screen><prompt>root # </prompt><command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     您也可以使用 SUSE Customer Center 或订阅管理工具。在 x86-64 上用于 SUSE Linux Enterprise 12 SP1 的命令为：
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     请注意，系统不支持跨体系结构升级。
    </para>
   </step>
   <step>
    <para>
     完成迁移：
    </para>
<screen><prompt>root # </prompt><command>zypper</command> ref -f -s
<prompt>root # </prompt><command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     第一个命令会更新所有服务和储存库。第二个命令会执行发行套件升级。在这里，最后两个选项比较重要：<option>-no-allow-vendor-change</option> 确保第三方 RPM 不会重写基础系统中的 RPM。<option>--no-recommends</option> 选项可确保初始安装过程中取消选择的包不会再次被添加。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.update.migr.ownscripts.onlinemigr">
  <title>手动迁移</title>
  <remark>toms 2016-07-13: Is this supported?</remark>
  <para>
   手动迁移或使用自己的脚本迁移需要对系统各组件有较为深入的了解。因此，下面的过程只推荐给专家级用户使用。
  </para>

  <para>
   要手动迁移系统，请执行以下操作：
  </para>

  <procedure>
   <step>
    <para>
     准备系统：
    </para>
    <substeps>
     <step>
      <para>
       从 SCC 取消注册当前系统：
      </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
     </step>
     <step>
      <para>
       禁用来自 DVD 的旧安装源。例如，检查 <filename>/etc/zypp/repos.d/SLES12-12-0.repo</filename>。
      </para>
     </step>
     <step>
      <para>
       查找所有第三方储存库并调整 URL。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     决定是通过 SUSE Customer Center 添加远程储存库，还是添加本地储存库：
    </para>
    <variablelist>
     <varlistentry>
      <term>通过 SCC 的远程安装源</term>
      <listitem>
       <para>
        通过联机通道添加新的安装源：
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 -r <replaceable>CODE</replaceable> -e <replaceable>EMAIL</replaceable></screen>
       <para>
        检查系统是否注册正确：
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>本地安装源</term>
      <listitem>
       <para>
        添加本地安装源：
       </para>
<screen><prompt>root # </prompt><command>zypper</command> ar -f http://example.com/media/SLES12SP2/
<prompt>root # </prompt><command>zypper</command> ar dvd:///?devices=/dev/sr0 SLES12SP2</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     刷新所有储存库：
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 ref -f -s</screen>
   </step>
   <step>
    <para>
     用 <command>zypper dup</command> 运行发行套件升级。
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 dup --no-allow-vendor-change --recommends</screen>
   </step>
   <step>
    <para>
     注册系统（如果还未注册）。
    </para>
   </step>
   <step>
    <para>
     检查系统是否注册正确：
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.rollback">
  <title>回滚服务包</title>

  <para>
   如果服务包不适合您，SUSE Linux Enterprise 支持在服务包迁移过程开始之前还原到以前的状态。
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     获取所有 Snapper 快照的列表：
    </para>
    <screen><prompt>root # </prompt><command>snapper</command> list</screen>
    <para>
     查看其输出并为下一步选择一个数字。有关 Snapper 的细节，请参见<xref linkend="cha.snapper"/>。
    </para>
   </step>
   <step>
    <para>
     选择 Snapper 快照进行回滚。提供上一步的数字：
    </para>
<screen><prompt>root # </prompt><command>snapper</command> rollback <replaceable>NUMBER</replaceable></screen>
   </step>
   <step>
    <para>
     恢复引导加载程序（有关细节，请参见<xref linkend="cha.grub2"/>）：
    </para>
<screen><prompt>root # </prompt><command>grub2</command> boot menu</screen>
    <para>
     引导期间会自动重设置注册。
    </para>
   </step>
   <step>
    <para>
     检查系统是否注册正确（有关更多信息，另请参见<xref linkend="sec.update.registersystem"/>）：
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
   <step>
    <para>
     如有需要，请修复注册：
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --rollback</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
