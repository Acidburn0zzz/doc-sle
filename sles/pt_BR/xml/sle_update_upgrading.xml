<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_upgrading.xml" version="5.0" xml:id="cha.update.sle">
  <title>Fazendo upgrade do SUSE Linux Enterprise</title>
  <info>
    <abstract>
      <para> O SUSE© Linux Enterprise (SLE) permite atualizar um sistema existente para a nova versão, por exemplo, do SLE 11 SP4 para o SLE 12. Não há necessidade de uma nova instalação. Dados existentes, como diretórios pessoais e de dados e configuração do sistema, permanecem intactos. É possível atualizar de uma unidade de CD ou DVD local ou de uma fonte de instalação de rede central. </para>
        <para>Este capítulo explica como fazer upgrade manualmente do sistema SUSE Linux Enterprise, seja de DVD, da rede, de um processo automatizado ou do SUSE Manager.</para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>yes (sim)</dm:translation>
      </dm:docmanager>
  </info>

  <sect1 xml:id="sec.update.prep">
    <title>Preparações gerais</title>

    <para> Antes de iniciar o procedimento de atualização, verifique se o sistema está preparado de forma apropriada. Entre outras coisas, a preparação envolve o backup dos dados e a verificação das notas de versão. </para>

    <sect2 xml:id="sec.update.prep.disks">
      <title>Particionamento e espaço em disco</title>
      <para> Antes de iniciar a atualização, anote a partição raiz. O comando <command>df /</command> relaciona o nome do dispositivo da partição raiz. Por exemplo, em <xref linkend="aus.update.df"/>, a partição raiz a ser anotada é a <filename>/dev/sda3</filename> (montada como <filename>/</filename>). </para>
      <example xml:id="aus.update.df">
        <title>Listar com <command>df -h</command></title>
        
        <screen os="sles">Filesystem     Size  Used Avail Use% Mounted on
/dev/sda3       74G   22G   53G  29% /
tmpfs          506M     0  506M   0% /dev/shm
/dev/sda5      116G  5.8G  111G   5% /home
/dev/sda1       44G    4G   40G   9% /data</screen>
      </example>
      <para> O software tende a <quote>crescer</quote> a cada versão. Portanto, verifique o espaço de partição disponível com <command>df</command> antes de atualizar. Se você achar que está ficando sem espaço em disco, proteja os dados antes de atualizar e reparticionar o sistema. Não há uma regra geral sobre a quantidade de espaço que cada partição deve ter. As exigências de espaço dependem do seu perfil de particionamento específico e do software selecionado. </para>
    </sect2>

    <sect2 xml:id="sec.update.prep.btrfs-on-root">
      <title>Verificar espaço no sistema de arquivos raiz Btrfs</title>
      <para>Se você usa o Btrfs como sistema de arquivos raiz em sua máquina, verifique se há espaço suficiente. É possível saber o espaço em disco por meio de um destes dois comandos:      
      </para>
      <screen><prompt>root # </prompt><command>btrfs</command> filesystem df /
<prompt>root # </prompt><command>df</command> /</screen>
      <para>O resultado dos dois comandos mostra números similares da quantidade de espaço em disco usada. No entanto, o problema com o Btrfs e o espaço livre é que você não sabe o que é e o que não é mencionado no instantâneo. Você não pode calcular a quantidade de espaço em disco que uma mudança necessita.</para>
      <para>Na pior das hipóteses, um upgrade precisará do mesmo espaço em disco que o sistema de arquivos raiz atual (sem <filename>/.snapshot</filename>). Além dos sistemas de arquivos Btrfs, verifique o espaço livre em outros sistemas de arquivos. A seguinte recomendação foi comprovada:
      </para>
      
      <itemizedlist>
        <listitem>
          <para>Para todos os sistemas de arquivos, incluindo o Btrfs, você precisa de espaço livre suficiente em disco para fazer download e instalar RPMs grandes. O espaço dos RPMs antigos serão liberados apenas depois da instalação dos novos RPMs.</para>
        </listitem>
        <listitem>
          <para>Para Btrfs com instantâneos, você precisa, no mínimo, do mesmo espaço livre que o espaço usado por sua instalação. É recomendado ter o dobro de espaço livre da quantidade de espaço usada pela instalação atual.
          </para>
          <para>Se você não tiver espaço livre suficiente, poderá tentar apagar instantâneos antigos com o <command>snapper</command>, desta forma:
          </para>
          <screen><prompt>root # </prompt><command>snapper</command> list
<prompt>root # </prompt><command>snapper</command> delete NUMBER</screen>
          <para>Porém, isso talvez não ajude em todos os casos. Antes da migração, a maioria dos instantâneos ocupa apenas um pouco de espaço.</para>
        </listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="sec.update.prep.relnotes">
      <title>Consultar as notas de versão</title>
      <para> Nas notas de versão, você encontra mais informações sobre o que mudou desde a versão anterior do SUSE Linux Enterprise. Verifique se o seu hardware ou configuração específico precisa de considerações especiais, quais dos seus pacotes de software específicos favoritos sofreram mudanças significativas e quais precauções você deve tomar além das recomendações gerais desta seção. As notas de versão também apresentam informações de último minuto e problemas conhecidos, que não puderam ser incluídos a tempo no manual. </para>
      <para> É possível ler online a versão atual do documento das notas de versão com as informações mais recentes sobre o <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> em <link xlink:href="http://www.suse.com/doc/"/>. </para>
    </sect2>

    <sect2 xml:id="sec.update.prep.backup">
      <title>Fazer um backup</title>
      <para> Antes de atualizar, copie os arquivos de configuração existentes em uma mídia separada (como dispositivo de fita, disco rígido removível, etc.) para fazer backup dos dados. Isso se aplica basicamente aos arquivos armazenados em <filename>/etc</filename>, assim como a alguns dos diretórios e arquivos em <filename>/var</filename> e <filename>/opt</filename>. Você também pode gravar os dados do usuário em <filename>/home</filename> (os diretórios <envar>HOME</envar>) em uma mídia de backup. Faça o backup desses dados como <systemitem class="username">root</systemitem>. Apenas o <systemitem class="username">root</systemitem> tem permissões de leitura para todos os arquivos locais. </para>
      <para> Se você selecionou <guimenu>Atualizar um Sistema Existente</guimenu> como o modo de instalação no YaST, poderá optar por fazer o backup (do sistema) em algum outro momento. É possível incluir todos os arquivos modificados e os arquivos do diretório <filename>/etc/sysconfig</filename>. Entretanto, esse não é um backup completo, já que todos os outros diretórios importantes mencionados anteriormente não estão incluídos. Encontre o backup no diretório <filename>/var/adm/backup</filename>. </para>
    </sect2>

    <sect2 xml:id="sec.update.prep.mariadb">
      <title>Migrar o banco de dados MySQL</title>
      <remark>toms 2015-09-03: already reviewed by Ondrej and Kristýna.</remark>
      <para>A partir do SUSE Linux Enterprise 12, o SUSE trocou o MySQL pelo MariaDB. Antes de você começar qualquer upgrade, é altamente recomendável fazer backup do banco de dados.
      </para>
      
      <para>Para executar a migração do banco de dados, faça o seguinte:</para>

      <procedure>
        <step>
          <para>Efetue login na máquina do SUSE Linux Enterprise 11.</para>
        </step>
        <step>
          <para>Criar um arquivo de dump:</para>
          <screen><prompt>root # </prompt><command>mysqldump</command> -u root -p --all-databases &gt; mysql_backup.sql</screen>
          <para>Por padrão, o <command>mysqldump</command> não descarrega o banco de dados <literal>INFORMATION_SCHEMA</literal> ou <literal>performance_schema</literal>. Para obter mais detalhes, consulte o <link xlink:href="https://dev.mysql.com/doc/refman/5.5/en/mysqldump.html"/>.
          </para>
        </step>
        <step>
          <para>Armazene o arquivo de dump, o arquivo de configuração <filename>/etc/my.cnf</filename> e o diretório <filename>/etc/mysql/</filename> para investigação futura (<emphasis>NÃO</emphasis> para instalação!) em um local seguro.</para>
        </step>
        <step>
          <para>Faça o upgrade. Após o upgrade, seu arquivo de configuração antigo <filename>/etc/my.cnf</filename> ainda estará intacto. Você encontra a nova configuração no arquivo <filename>/etc/my.cnf.rpmnew</filename>.</para>
        </step>
        <step>
          <para>Configure o banco de dados MariaDB de acordo com as suas necessidades. <emphasis>NÃO</emphasis> use o arquivo de configuração e o diretório antigos, mas use-os como base e adapte-os.</para>
        </step>
        <step>
          <para>Inicie o servidor MariaDB:</para>
          <screen><prompt>root # </prompt><command>systemctl</command> start mysql</screen>
          <para>Para iniciar o servidor MariaDB em cada boot, habilite o serviço:</para>
          <screen><prompt>root # </prompt><command>systemctl</command> enable mysql</screen>
          
        </step>
        <step>
          <para>Verifique se o MariaDB está sendo executado apropriadamente conectando-se com o banco de dados:</para>
          <screen><prompt>root # </prompt><command>mysql</command> -u root -p</screen>
        </step>
      </procedure>
    </sect2>

    <sect2 xml:id="sec.update.prep.postgresql">
      <title>Migrar o banco de dados PostgreSQL</title>
      <remark>toms 2015-09-09: FATE#319049</remark>
      <remark>Already reviewd by Reinhard</remark>
      <para>O SLE11 SP3 e o SLE12 GA recebem uma versão mais recente do banco de dados PostgreSQL como uma atualização de manutenção. Por causa do trabalho de migração do banco de dados necessário, não existe um processo de upgrade automático. Dessa forma, a mudança de uma versão para outra deve ser feita manualmente. </para>
      <para>O processo de migração é realizado pelo comando <command>pg_upgrade</command>, que é um método alternativo do clássico dump e recarregamento. Em comparação com o método <quote>dump e recarregamento</quote>, o <command>pg_upgrade</command> reduz o tempo da migração.
      </para>
      <para>Cada versão do PostgreSQL armazena seus arquivos em diretórios diferentes dependentes da versão. Após a atualização, os diretórios serão mudados para:</para>
      <variablelist>
        <varlistentry>
          <term>SLE11 SP3/SP4</term>
          <listitem>
            <para><filename>/usr/lib/postgresql91/</filename> para <filename>/usr/lib/postgresql94/</filename></para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>SLE12 GA</term>
          <listitem>
            <para>
              <filename>/usr/lib/postgresql93/</filename> para <filename>/usr/lib/postgresql94/</filename>
            </para>
          </listitem>
        </varlistentry>
      </variablelist>
      <para>Para executar a migração do banco de dados, faça o seguinte:</para>
      <procedure>
        <step>
          <para>Verifique se as seguintes pré-condições foram atendidas:</para>
          <itemizedlist>
            <listitem>
              <para>Caso ainda não tenha sido feito, faça upgrade de qualquer pacote da versão antiga do PostgreSQL para a versão mais recente por meio de uma atualização de manutenção.</para>
            </listitem>
            <listitem>
              <para>Crie um backup do seu banco de dados existente.</para>
            </listitem>
            <listitem>
              <para>Instale os pacotes da nova versão principal do PostgreSQL. Para o SLE12, isso significa instalar o
                  <package>postgresql94-server</package> e todos os pacotes dos quais ele depende.</para>
            </listitem>
            <listitem>
              <para>Instale o pacote
                  <package>postgresql94-contrib</package> que contém o comando <command>pg_upgrade</command>. </para>
            </listitem>
            <listitem>
              <para>Verifique se você tem espaço livre suficiente na área de dados do PostgreSQL, que é <filename>/var/lib/pgsql/data</filename>, por padrão. Se o espaço for pouco, tente reduzir o tamanho com o seguinte comando SQL em cada banco de dados (pode levar muito tempo!): </para>
              <screen>VACUUM FULL</screen>
            </listitem>
          </itemizedlist>
        </step>
        <step>
          <para>Pare o servidor PostgreSQL:</para>
          <screen><prompt>root # </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
        </step>
        <step>
          <para>Renomeie o diretório de dados antigo:</para>
          <screen><prompt>root # </prompt><command>mv</command> /var/lib/pgsql/data /var/lib/pgsql/data.old</screen>
        </step>
        <step>
          <para>Crie um novo diretório de dados:</para>
          <screen><prompt>root # </prompt><command>mkdir</command> -p /var/lib/pgsql/data</screen>
        </step>
        <step>
          <para>Se você mudou os arquivos de configuração na versão antiga, copie os arquivos <filename>postgresql.conf</filename> <filename>pg_hba.conf</filename> para o novo diretório de <filename>dados</filename>:
            <screen><prompt>root # </prompt><command>cp</command> /var/lib/pgsql/data.old/*.conf \
     /var/lib/pgsql/data</screen>
          </para>
        </step>
        <step>
          <para>Inicialize a nova instância do banco de dados manualmente com <command>initdb</command> ou iniciando e parando o PostgreSQL, que fará isso automaticamente:
          </para>
          <screen><prompt>root # </prompt><command>/usr/sbin/rcpostgresql</command> start
<prompt>root # </prompt><command>/usr/sbin/rcpostgresql</command> stop</screen>
        </step>
        <step>
          <para>Inicie o processo de migração e substitua o marcador <replaceable>OLD</replaceable> pela versão mais antiga:</para>
          <screen><prompt>root # </prompt><command>pg_upgrade</command> \
   --old-datadir "/var/lib/pgsql/data.old" \
   --new-datadir "/var/lib/pgsql/data" \
   --old-bindir "/usr/lib/postgresql<replaceable>OLD</replaceable>/bin/" \
   --new-bindir "/usr/lib/postgresql94/bin/"</screen>
        </step>
        <step>
          <para>Inicie a nova instância do banco de dados:</para>
          <screen><prompt>root # </prompt><command>/usr/sbin/rcpostgresql</command> start</screen>
        </step>
        <step>
          <para>Verifique se a migração foi bem-sucedida. Não existe uma ferramenta geral para automatizar essa etapa. Isso depende do seu caso de uso, do volume e do que você deseja testar.</para>
        </step>
        <step>
          <para>Remova qualquer pacote antigo do PostgreSQL e o diretório de dados antigo:</para>
          <screen><prompt>root # </prompt><command>zypper</command> search -s postgresql<replaceable>OLD</replaceable> | xargs zypper rm -u
<prompt>root # </prompt><command>rm</command> -rf /var/lib/pgsql/data.old</screen>
        </step>
      </procedure>
    </sect2>

    <sect2 xml:id="sec.update.prep.vms">
      <title>Encerrar convidados de máquinas virtuais</title>
      <para> Se a sua máquina atuar como Servidor de Host de VM do KVM ou Xen, encerre apropriadamente todos os Convidados de VM em execução antes da atualização. Do contrário, pode não ser possível acessar os convidados após a atualização. </para>
    </sect2>
  </sect1>

  <sect1 xml:id="sec.update.proc.prep.paths">
    <title>Caminhos de upgrade suportados para o SLE</title>
    
    <important>
      <title>Upgrades compatíveis com várias arquiteturas não são suportados</title>
      <para> Upgrades compatíveis com várias arquiteturas, como um upgrade da versão de 32 bits do <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> para a versão de 64 bits, ou de big endian para little endian, <emphasis>não</emphasis> são suportados! </para>
      <para> Especificamente, o upgrade do SLE 11 on POWER (big endian) para o SLE 12 SP1 on POWER (novo: little endian!) <emphasis>não</emphasis> é suportado. </para>
      <para> Além disso, como o SUSE Linux Enterprise 12 é apenas de 64 bits, os upgrades de qualquer sistema SUSE Linux Enterprise 11 de 32 bits para o SUSE Linux Enterprise 12 e posterior <emphasis>não</emphasis> são suportados. </para>
    </important>
    
    <para>Antes de fazer qualquer migração, leia a <xref linkend="sec.update.prep"/>.</para>

    <variablelist>
      <varlistentry>
        <term>Fazendo upgrade do SUSE Linux Enterprise 10 (qualquer Service Pack)</term>
        <listitem>
          <para> Não há um caminho de migração direto suportado para o SUSE Linux Enterprise 12. Em vez disso, é recomendada uma nova instalação. </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Fazendo upgrade do SUSE Linux Enterprise 11 GA, SP1 ou SP2</term>
        <listitem>
          <para>Não há um caminho de migração direto suportado para o SUSE Linux Enterprise 12. No mínimo, você precisa do SLE 11 SP3 antes de proceder para o SLE 12.</para>
          <para>Caso não consiga fazer uma nova instalação, você terá que atualizar primeiro do SLE 11 GA para o SP1, depois do SLE 11 SP1 para o SP2 e, na sequência, do SLE 11 SP2 para o SP3. Essas etapas estão descritas no <link xlink:href="https://www.suse.com/documentation/sles11/">Guia de Implantação do SUSE Linux Enterprise 11</link>. </para>
          <para> Em seguida, continue na <xref linkend="sec.update.sle12"/>. </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Fazendo upgrade do SUSE Linux Enterprise 11 SP3 ou SP4</term>
        <listitem>
          <para> Consulte <xref linkend="sec.update.sle12"/> para obter os detalhes. </para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Fazendo upgrade do SUSE Linux Enterprise 12 para SP1</term>
        <listitem>
          <para>Consulte <xref linkend="cha.update.spmigration"/> para obter os detalhes.</para>
        </listitem>
      </varlistentry>
    </variablelist>
  </sect1>

  <sect1 xml:id="sec.update.sle12">
  <title>Métodos suportados para fazer upgrade do SUSE Linux Enterprise</title>
  <remark>toms 2014-02-11: See FATEs #315969 and #313189</remark>
  <para>
   Use um dos métodos a seguir para fazer upgrade do SUSE Linux Enterprise 11 SP3 para o SUSE Linux Enterprise 12, do SUSE Linux Enterprise 11 SP3 para o SUSE Linux Enterprise 12 SP1 ou do SUSE Linux Enterprise 11 SP4 para o SUSE Linux Enterprise 12 SP1:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Upgrade manual, inicialização de um meio de instalação (consulte a <xref linkend="sec.update.sle12.manual"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Migração semiautomatizada, possível por SSH <phrase os="sles">(consulte a <xref linkend="sec.update.sle12.automated"/>)</phrase> ou com o <xref linkend="cha.update.spmigration"/>.
    </para>
   </listitem>
  </itemizedlist>
  </sect1>

  <sect1 xml:id="sec.update.sle12.manual">
   <title>Fazendo upgrade manualmente do SLE 11 SP3 para o SLE 12 SP1, usando uma fonte de instalação</title>
   <para>
    Antes de fazer upgrade do sistema, leia a <xref linkend="sec.update.prep"/>.
   </para>
   <para>
    Para fazer upgrade do sistema dessa forma, você precisa inicializá-lo de uma fonte de instalação, como faz no caso de uma nova instalação. Porém, quando a tela de boot aparecer, você deverá selecionar <guimenu>Upgrade</guimenu> (em vez de <guimenu>Instalação</guimenu>). A fonte de instalação da qual inicializar pode ser uma das seguintes:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Um meio de instalação local (como DVD ou uma imagem ISO em um dispositivo de armazenamento em massa USB). Para obter instruções detalhadas, consulte a <xref linkend="sec.update.sle12.manual.dvd"/>.
     </para>
    </listitem>
    <listitem>
     <para>
      Uma fonte de instalação de rede. É possível inicializar do meio local e, em seguida, selecionar o respectivo tipo de instalação de rede, ou inicializar via PXE. Para obter instruções detalhadas, consulte a <xref linkend="sec.update.sle12.manual.network"/>.
     </para>
    </listitem>
   </itemizedlist>
   <sect2 xml:id="sec.update.sle12.manual.dvd">
    <title>Fazendo upgrade de um meio de instalação</title>
    <para>
     O procedimento a seguir descreve a inicialização de um DVD, como exemplo, mas você também pode usar outro meio de instalação local, como uma imagem ISO em um dispositivo de armazenamento em massa USB. A maneira de selecionar o método de boot e inicializar o sistema do meio depende da arquitetura do sistema e se a máquina tem BIOS tradicional ou UEFI. Para obter detalhes, consulte os links a seguir.
    </para>
    <procedure xml:id="pro.update.sle12.manual.dvd">
     <title>Fazendo upgrade manualmente do SLE 11 SP3 para o SLE 12 SP1, usando um DVD</title>
     <step>
      <para>
       Insira o DVD 1 do meio de instalação do SUSE Linux Enterprise 12 SP1 e inicialize a máquina. Uma tela de <guimenu>boas-vindas</guimenu> aparece seguida da tela de boot.
      </para>
     </step>
     <step>
      <para>
       Selecione o respectivo método de boot para iniciar o sistema do meio (consulte a <xref linkend="sec.i.yast2.method"/>).
      </para>
     </step>
     <step>
      <para>
       Inicialize o sistema do meio (consulte a <xref linkend="sec.i.yast2.startup"/>).
      </para>
     </step>
     <step>
      <para>
       Prossiga com o processo de upgrade conforme descrito na <xref linkend="sec.update.sle12.start.upgr.after.boot"/>.
      </para>
     </step>
    </procedure>
   </sect2>
   <sect2 xml:id="sec.update.sle12.manual.network">
    <title>Fazendo upgrade de uma fonte de instalação de rede</title>
    <para>
     Para iniciar o upgrade de uma fonte de instalação de rede, você deve cumprir os seguintes requisitos:
    </para>
    <variablelist>
     <title>Requisitos para upgrade de uma fonte de instalação de rede</title>
     <varlistentry>
      <term>Fonte de Instalação de Rede</term>
      <listitem>
       <para>
        Configuração de uma fonte de instalação de rede de acordo com a <xref linkend="sec.deployment.remoteinst.instserver"/>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Conexão de Rede e Serviços de Rede</term>
      <listitem>
       <para>
        Ambos o servidor de instalação e a máquina de destino têm uma conexão de rede ativa. A rede deve fornecer os seguintes serviços: serviço de nomes, DHCP (opcional, mas necessário para inicialização via PXE) e OpenSLP (opcional).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Mídia de instalação</term>
      <listitem>
       <para>
        Você tem o DVD 1 do SUSE Linux Enterprise (ou uma imagem ISO local) nas mãos para inicializar o sistema de destino <emphasis>ou</emphasis> um sistema de destino que está configurado para inicialização via PXE, de acordo com a <xref linkend="sec.deployment.remoteinst.boot.pxeprep" xrefstyle="HeadingOnPage"/>. Consulte o <xref linkend="cha.deployment.remoteinst"/> para obter informações detalhadas sobre como iniciar o upgrade de um servidor remoto.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Ao fazer upgrade da fonte de instalação de rede, você pode inicializar do meio local e, em seguida, selecionar o respectivo tipo de instalação de rede, ou inicializar via PXE. Selecione o método de sua preferência e prossiga conforme descrito em <xref linkend="pro.update.sle12.manual.network.boot-from-dvd" xrefstyle="select:label"/> ou <xref linkend="pro.update.sle12.manual.network.pxe-boot" xrefstyle="select:label"/>.
    </para>
    <procedure xml:id="pro.update.sle12.manual.network.boot-from-dvd">
     <title>Fazendo upgrade manualmente do SLE 11 SP3 ou do SP4 para o SLE 12 SP1 por fonte de instalação de rede, inicializando do DVD</title>
     <para>
      Esse procedimento descreve a inicialização de um DVD, como exemplo, mas você também pode usar outro meio de instalação local, como uma imagem ISO em um dispositivo de armazenamento em massa USB. A maneira de selecionar o método de boot e inicializar o sistema do meio depende da arquitetura do sistema e se a máquina tem BIOS tradicional ou UEFI. Para obter detalhes, consulte os links a seguir.
     </para>
     <step>
      <para>
       Insira o DVD 1 da mídia de instalação do SUSE Linux Enterprise 12 SP1 e inicialize a máquina. Uma tela de <guimenu>boas-vindas</guimenu> aparece seguida da tela de boot.
      </para>
     </step>
     <step>
      <para>
       Selecione o tipo de fonte de instalação de rede que deseja usar (FTP, HTTP, NFS, SMB ou SLP). Normalmente, você vê essa opção pressionando <keycap>F4</keycap>, mas caso sua máquina esteja equipada com UEFI, e não com um BIOS tradicional, talvez seja necessário ajustar os parâmetros de boot manualmente. Para obter detalhes, consulte a <xref linkend="sec.i.yast2.source.net"/> no <xref linkend="cha.inst"/>.
      </para>
     </step>
     <step>
      <para>
       Prossiga com o processo de upgrade conforme descrito na <xref linkend="sec.update.sle12.start.upgr.after.boot"/>.
      </para>
     </step>
    </procedure>
    <procedure xml:id="pro.update.sle12.manual.network.pxe-boot">
     <title>Fazendo upgrade manualmente do SLE 11 SP3 ou do SP4 para o SLE 12 SP1 por fonte de instalação de rede, inicializando via PXE</title>
     <para>
      Para fazer upgrade de uma fonte de instalação de rede usando Boot PXE, faça o seguinte:
     </para>
     <step>
      <para>
       Ajuste a configuração do servidor DHCP para fornecer as informações de endereço necessárias à inicialização via PXE. Para obter os detalhes, consulte a <xref linkend="sec.deployment.remoteinst.boot.pxeprep"/>.
      </para>
     </step>
     <step>
      <para>
       Configure um servidor TFTP para manter a imagem de boot necessária à inicialização via PXE. Use o DVD 1 da mídia de instalação do SUSE Linux Enterprise 12 SP1 para isso ou siga as instruções na <xref linkend="sec.deployment.remoteinst.boot.tftp"/>.
      </para>
     </step>
     <step>
      <para>
       Prepare o Boot PXE e o Wake-on-LAN na máquina de destino.
      </para>
     </step>
     <step>
      <para>
       Inicialize o sistema de destino e use o VNC para conectar-se remotamente à rotina de instalação que está sendo executada nessa máquina. Para obter mais informações, consulte a <xref linkend="sec.deployment.remoteinst.monitor.vnc"/>.
      </para>
     </step>
     <step>
      <para>
       Prossiga com o processo de upgrade conforme descrito na <xref linkend="sec.update.sle12.start.upgr.after.boot"/>.
      </para>
     </step>
    </procedure>
   </sect2>
  </sect1>

  <sect1 xml:id="sec.update.sle12.automated">
   <title>Migrando automaticamente do SLE 11 SP3 ou do SP4 para o SLE 12 SP1</title>
   <para>
    Antes de fazer upgrade do sistema, leia a <xref linkend="sec.update.prep"/>. Para executar a migração automatizada, faça o seguinte:
   </para>
   <procedure xml:id="pro.update.sle12.automated">
    <title>Migração automatizada do SUSE Linux Enterprise 11 SP3 para o SUSE Linux Enterprise 12 SP1</title>
    <remark>toms 2014-03-19: See FATE#315037</remark>
    <remark role="future">toms 2014-03-20: From SLE12 SP1 on, we should probably base
    this example on GRUB2, but not for GA.</remark>
     <remark>jsrain 2015-09-02: This is still the old system; at some point
       of time we should switch to GRUB2, but as long as amjority of
       customers still runs SLE11, I would stay with legacy GRUB. Anyway, we
       could include both op6tions, that would be probably best solution</remark>
    <step>
     <para>
      Copie o <filename>linux</filename> do Kernel de instalação e o arquivo <filename>initrd</filename> de <filename>/boot/x86_64/loader/</filename> do primeiro DVD de instalação para o diretório <filename>/boot</filename> do sistema:
     </para>
<screen><command>cp</command> -vi <replaceable>DVDROOT</replaceable>/boot/x86_64/loader/linux /boot/linux.upgrade
<command>cp</command> -vi <replaceable>DVDROOT</replaceable>/boot/x86_64/loader/initrd /boot/initrd.upgrade</screen>
     <para>
      <replaceable>RAIZDODVD</replaceable> indica o caminho no qual o sistema monta o DVD, geralmente, <filename>/run/media/$USER/$DVDNAME</filename>.
     </para>
    </step>
    <step>
     <para>
      Abra o arquivo de configuração legado do GRUB <filename>/boot/grub/menu.lst</filename> e adicione outra seção. Para outros carregadores de boot, edite o(s) respectivo(s) arquivo(s) de configuração. Ajuste os nomes de dispositivo e o parâmetro <parameter>usuário</parameter> de acordo. Por exemplo:
     </para>
<screen>title Linux Upgrade Kernel
kernel (hd0,0)/boot/linux.upgrade root=/dev/sda1 upgrade=1 <replaceable>OPTIONAL_PARAMETERS</replaceable>
initrd (hd0,0)/boot/initrd.upgrade</screen>
     <para>
      <replaceable>PARÂMETROS_OPCIONAIS</replaceable> indicam os parâmetros de boot adicionais que talvez sejam necessários para inicializar o sistema e executar o upgrade. Eles podem ser os parâmetros do kernel necessários para o seu sistema. Verifique se é necessário revisá-los e copiá-los de uma entrada existente do GRUB. Eles também podem ser os <link xlink:href="http://en.opensuse.org/Linuxrc">parâmetros linuxrc do SUSE, documentados online</link>.
     </para>
    </step>
    <step>
     <para>
      Se o upgrade tiver que ser feito de forma automática <phrase os="sles"> (consulte a <xref linkend="sec.update.auto.run"/>)</phrase>, adicione <option>autoupgrade=1</option> ao fim da linha do <literal>kernel</literal> na configuração do GRUB.
     </para>
    </step>
    <step>
     <para>
      Reinicialize a máquina e selecione a seção recém-adicionada no menu de boot (aqui: <emphasis>Linux Upgrade Kernel</emphasis> "Kernel de Upgrade do Linux"). É possível usar o <command>grubonce</command> para pré-selecionar a entrada do GRUB recém-criada para reinicialização automática autônoma na entrada recém-criada. É possível também usar <command>reboot</command> para iniciar a reinicialização da linha de comando.
     </para>
    </step>
    <step>
     <para>
      Prossiga com o processo de upgrade normal conforme descrito na <xref linkend="sec.update.sle12.start.upgr.after.boot"/>.
     </para>
    </step>
    <step>
     <para>
      Após o término bem-sucedido do processo de upgrade, remova o Kernel de instalação e os arquivos initrd (<filename>/boot/linux.upgrade</filename> e <filename>/boot/initrd.upgrade</filename>). Eles não serão mais necessários.
     </para>
    </step>
   </procedure>
  </sect1>

  <sect1 xml:id="sec.update.sle12.start.upgr.after.boot">
   <title>Iniciando o processo de upgrade após a inicialização</title>
   <para>
    <remark>taroth 2014-11-13: argh, the following is terminology hell regarding
     the software strings: "upgrade"/"update" are used intermittently and
     without clear differentiation...</remark>
   </para>
   <procedure>
    <step>
     <para>
      Após a inicialização (de um meio de instalação ou da rede), selecione a entrada <guimenu>Upgrade</guimenu> na tela de boot.
     </para>
     <warning>
      <title>A opção errada pode levar a perda de dados</title>
      <para>
       Se você selecionar <guimenu>Instalação</guimenu> em vez de <guimenu>Upgrade</guimenu>, poderá haver perda de dados posteriormente. É necessário tomar mais cuidado para não destruir suas partições de dados ao fazer uma instalação nova, por exemplo, reparticionando os discos (que pode destruir as partições existentes) ou reformatando as partições de dados (que apaga todos os seus dados).
      </para>
      <para>
       Selecione <guimenu>Upgrade</guimenu> neste momento.
      </para>
     </warning>
     <para>
      O YaST inicia o sistema de instalação.
     </para>
    </step>
    <step>
     <para>
      Na tela de <guimenu>boas-vindas</guimenu>, escolha <guimenu>Idioma</guimenu> e <guimenu>Teclado</guimenu> e aceite o contrato de licença. Continue com <guimenu>Avançar</guimenu>.
     </para>
     <para>
      O YaST verifica se já existem sistemas do SUSE Linux Enterprise instalados em suas partições.
     </para>
    </step>
    <step>
     <para>
      Na tela <guimenu>Select for Upgrade</guimenu> (Selecionar para Upgrade), selecione a partição para fazer upgrade e clique em <guimenu>Avançar</guimenu>.
     </para>
     <para>
      O YaST monta a partição selecionada e exibe todos os repositórios encontrados na partição da qual você deseja fazer o upgrade.
     </para>
    </step>
    <step>
     <para>
      Na tela <guimenu>Repositórios Previamente Utilizados</guimenu>, ajuste o status dos repositórios: habilite os que deseja incluir no processo de upgrade e desabilite todos os repositórios que não são mais necessários. Continue com <guimenu>Avançar</guimenu>.
     </para>
    </step>
    <step>
     <para>
      Na tela <guimenu>Registro</guimenu>, selecione se é para registrar agora o sistema do qual foi feito o upgrade (digitando os dados de registro e clicando em <guimenu>Avançar</guimenu>) ou se é para <guimenu>Ignorar Registro</guimenu>. Para obter detalhes sobre como registrar o sistema, consulte a <xref linkend="sec.update.registersystem"/>.
     </para>
     <para>
      A tela seguinte <guimenu>Configurações de Instalação</guimenu> é a última etapa antes de iniciar o upgrade.
     </para>
    </step>
    <step>
     <para>
      Revise as <guimenu>Configurações de Instalação</guimenu> do upgrade, principalmente as <guimenu>Opções de Atualização</guimenu>. Escolha entre as seguintes opções:
     </para>
     <itemizedlist>
      <listitem>
       <para>
        <guimenu>Somente Atualizar Pacotes Instalados</guimenu>, nesse caso, você pode perder os novos recursos que fazem parte da versão mais recente do SUSE Linux Enterprise.
       </para>
      </listitem>
      <listitem>
       <para>
        <guimenu>Atualizar com Instalação de Novo Software ou Recursos</guimenu>. Clique em <guimenu>Selecionar Padrões</guimenu> para habilitar ou desabilitar padrões e pacotes conforme desejado.
       </para>
      </listitem>
     </itemizedlist>

     <note>
      <title>Opções de área de trabalho</title>
      <para>
       Se você usava o KDE antes de fazer upgrade para o SUSE Linux Enterprise 12 (<varname>DEFAULT_WM</varname> em <filename>/etc/sysconfig/windowmanager</filename> estava definido como <literal>kde*</literal>), seu ambiente de área de trabalho será automaticamente substituído pelo GNOME após o upgrade. Por padrão, o gerenciador de exibição do KDM será substituído pelo GDM.
      </para>
      <para>
       Para mudar a opção de ambiente de área de trabalho ou gerenciador de janelas, ajuste a seleção de software clicando em <guimenu>Selecionar Padrões</guimenu>.
      </para>
     </note>
    </step>
    <step>
     <para>
      Se todas as configurações estiverem conforme desejado, inicie o procedimento de instalação e remoção clicando em <guimenu>Atualizar</guimenu>.
     </para>
    </step>
   </procedure>
  </sect1>

  <sect1 xml:id="sec.update.sle12.manager">
   <title>Atualizando pelo SUSE Manager</title>
   <para>
    O SUSE Manager é uma solução de servidor que oferece atualizações, patches e correções de segurança para clientes SUSE Linux Enterprise. Ele vem com um conjunto de ferramentas e uma interface do usuário baseada na Web para as tarefas de gerenciamento.
   </para>
   <para>
     <remark>toms 2015-08-24: Adapt this link to a better source; at the
     time being, this was the best what we can get.</remark> A documentação do SUSE Manager no site <link xlink:href="https://www.suse.com/documentation/suse_manager/book_susemanager_install/data/s1-maintenance-update.html"/> apresenta uma visão geral dos recursos e instruções de como configurar servidor e clientes.
   </para>
  </sect1>

  <sect1 xml:id="sec.update.registersystem">
    <title>Registrando seu sistema</title>

    <para>
      Se você ignorou a etapa de registro durante a instalação, poderá registrar seu sistema a qualquer momento por meio do módulo <guimenu>Registro de Produto</guimenu> no YaST.
    </para>
    <para>O registro de sistemas tem as seguintes vantagens:</para>
    <itemizedlist>
      <listitem>
        <para>Receber suporte</para>
      </listitem>
      <listitem>
        <para>Receber atualizações de segurança e correções de bugs</para>
      </listitem>
      <listitem>
        <para>Acessar o SUSE Customer Center</para>
      </listitem>
    </itemizedlist>

    <procedure>
      <step>
        <para>
          Inicie o YaST e selecione <menuchoice> <guimenu>Software</guimenu> <guimenu>Registro de Produto</guimenu> </menuchoice> para abrir a caixa de diálogo <guimenu>Registro</guimenu>.
        </para>
      </step>
      <step>
        <para>
          Informe o endereço de <guimenu>E-mail</guimenu> associado à conta do SUSE que você ou sua organização usa para gerenciar inscrições. Se você ainda não tem uma conta do SUSE, vá para a home page do SUSE Customer Center (<link xlink:show="new" xlink:href="https://scc.suse.com/"/>) para criar uma.
        </para>
      </step>
      <step>
        <para>
          Digite o <guimenu>Código de Registro</guimenu> que você recebeu com a cópia do <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>.
        </para>
      </step>
      <step xml:id="step.y2.register.final">
        <para>
          Prossiga com <guimenu>Avançar</guimenu> para iniciar o processo de registro. Se houver um ou mais servidores de registro locais disponíveis na rede, você poderá escolher um deles na lista. Se preferir, escolha <guimenu>Cancelar</guimenu> para ignorar os servidores de registro locais e registrar usando o servidor de registro padrão do SUSE.
        </para>
        <para>
          Durante o registro, os canais de atualização online serão adicionados à configuração de instalação.
        </para>
        <para>
          Após o registro bem-sucedido, o YaST mostrará uma lista de extensões, complementos e módulos que estão disponíveis para o seu sistema. Para selecioná-los e instalá-los, continue na <xref linkend="sec.add-ons.extensions"/>.
        </para>
      </step>
    </procedure>
  </sect1>

  <sect1 xml:id="sec.update.sle12.multiversion">
    <title>Mantendo pacotes do Kernel</title>
    <remark>toms 2015-08-26: bsc#753809</remark> <remark>toms 2015-08-26: some parts are taken ("stolen") from the
      wiki at https://en.opensuse.org/SDB:Keep_multiple_kernel_versions
      and adapted
    </remark> <indexterm> <primary>kernels multiversão</primary> </indexterm>
    <para>Ao instalar um novo kernel com o YaST ou o Zypper, o SUSE Linux Enterprise preserva os dois últimos kernels e o que está em execução. Na maioria dos casos, isso é o suficiente.</para>
    <para>Entretanto, pode haver situações em que você tenha que preservar mais versões de kernel para fins de teste, por exemplo. Para permitir isso, o SUSE Linux Enterprise suporta o <emphasis>recurso de kernel multiversão</emphasis>. Ao habilitar e configurar esse recurso, o comportamento padrão pode ser mudado e configurado para: </para>
    <itemizedlist>
      <listitem>
        <para>apagar um kernel antigo apenas depois que o sistema for reinicializado com êxito com o novo kernel</para>
      </listitem>
      <listitem>
        <para>manter um número especificado de kernels mais antigos como fallback</para>
      </listitem>
      <listitem>
        <para>manter uma versão específica do kernel </para>
      </listitem>
    </itemizedlist>
    <para>Após a reinicialização bem-sucedida, um script vai comparar a lista de kernels instalados com as configurações em <filename>/etc/zypp/zypp.conf</filename> e apagar aqueles que não forem mais necessários. </para>
    <sect2 xml:id="sec.update.sle12.multiversion.enable">
      <title>Habilitando o recurso de kernel multiversão</title>
      <para>O comportamento padrão é definido no arquivo de configuração <filename>/etc/zypp/zypp.conf</filename>:</para>
      <screen><prompt>root # </prompt><command>grep</command> ^multiversion /etc/zypp/zypp.conf
multiversion = provides:multiversion(kernel)
multiversion.kernels = latest,latest-1,running</screen>
      <para>Remova qualquer marca # antes da linha <literal>multiversion</literal> acima para habilitar esse recurso (que já deve ser o caso). A segunda linha é usada para configurar <emphasis>quais</emphasis> kernels precisam ser preservados. É necessário habilitar os dois, do contrário, o sistema manterá <emphasis>todos</emphasis> os kernels, ocupando o disco rígido. </para>
      <para>A linha <literal>multiversion.kernels</literal> pode incluir várias palavras-chave em diferentes combinações e ordem:</para>
      <variablelist>
        <varlistentry>
          <term><option>mais recente</option></term>
          <listitem>
            <para>Manter o kernel com o número de versão mais alto</para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><option>latest-<replaceable>N</replaceable></option></term>
          <listitem>
            <para>Manter o kernel com o <replaceable>N</replaceable>º número de versão mais alto; <replaceable>N</replaceable> é um número a partir de 1</para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><option>em execução</option></term>
          <listitem>
            <para>Manter o kernel em execução no momento</para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><option>oldest</option></term>
          <listitem>
            <para>Manter o kernel com o número de versão mais baixo (o kernel no produto lançado)</para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><option>oldest-<replaceable>N</replaceable></option></term>
          <listitem>
            <para>Manter o kernel com o <replaceable>N</replaceable>º número de versão mais baixo</para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><option>3.12.28-4.6</option></term>
          <listitem>
            <para>Manter esta versão exata do kernel</para>
          </listitem>
        </varlistentry>
      </variablelist>
    </sect2>

    <sect2 xml:id="sec.update.sle12.multiversion.deleteoldkernel">
      <title>Caso de uso: apagando um kernel antigo apenas depois da reinicialização</title>
      <para>Você deseja garantir que um kernel antigo seja apagado apenas depois que o sistema for reinicializado com êxito do novo kernel. </para>
      <para>Mude a seguinte linha em <filename>/etc/zypp/zypp.conf</filename>:</para>
      <screen>multiversion.kernels = latest,running</screen>
      <para>Os parâmetros anteriores pedem para o sistema manter o kernel mais recente e o que está em execução apenas se eles forem diferentes.</para>
    </sect2>

    <sect2 xml:id="sec.update.sle12.multiversion.fallback">
      <title>Caso de uso: mantendo kernels mais antigos como fallback</title>
      <para>Convém manter uma ou mais versões de kernel para ter um ou mais kernels <quote>sobressalentes</quote>.</para>
      <para>Esse caso de uso poderá ser útil se você precisar de kernels por motivos de teste. Se alguma coisa der errado, por exemplo, sua máquina não será inicializada, você ainda poderá usar uma ou mais versões de kernel, que são reconhecidamente boas.</para>
      <para>Mude a seguinte linha em <filename>/etc/zypp/zypp.conf</filename>:</para>
      <screen>multiversion.kernels = latest,latest-1,latest-2,running</screen>
      <para>Quando você reinicializa o sistema após a instalação de um novo kernel, o sistema mantém três kernels: o kernel novo em execução (configurado como <literal>latest,running</literal>), a versão de kernel anterior do novo kernel (configurada como <literal>latest-1</literal>) e o antecessor da versão do kernel anterior (configurada como <literal>latest-2</literal>). </para>
    </sect2>

    <sect2 xml:id="sec.update.sle12.multiversion.specificversion">
      <title>Caso de uso: manter uma versão específica do kernel</title>
      <para>Você faz atualizações de sistema regulares e instala novas versões de kernel. Porém, você também está compilando sua própria versão de kernel por vários motivos e deseja garantir que o sistema a manterá.
      </para>
      <para>Mude a seguinte linha em <filename>/etc/zypp/zypp.conf</filename>:</para>
      <screen>multiversion.kernels = latest,3.12.28-4.20,running</screen>
      <para>Quando você reinicializa o sistema após a instalação de um novo kernel, o sistema mantém dois kernels: o kernel novo em execução (configurado como <literal>latest,running</literal>) e o seu próprio kernel compilado (configurado como <literal>3.12.28-4.20</literal>).
      </para>
    </sect2>
  </sect1>
</chapter>
