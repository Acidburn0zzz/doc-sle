<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_migration.xml" version="5.0" xml:id="cha.update.spmigration">
 <title>Migração de service pack</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes (sim)</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    O SUSE oferece uma ferramenta gráfica e de linha de comando para fazer upgrade para um novo pacote de serviço. Tratam-se de ferramentas de linha de comando simples, de uma interface gráfica do usuário intuitiva, de suporte a <quote>rollback</quote> de pacotes de serviço, etc. Este capítulo explica passo a passo como fazer a migração do pacote de serviço com essas ferramentas.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>Visão geral conceitual</title>

  <para>
   A SUSE lança novos pacotes de serviço para a família do SUSE Linux Enterprise regularmente. Para facilitar aos clientes a migração para um novo pacote de serviço e minimizar o tempo de espera, o SUSE oferece suporte à migração online durante a execução do sistema.
  </para>

  <para>
   A partir do SLE 12 SP2, o YaST Wagon foi substituído pela migração do YaST (GUI) e pela migração do Zypper (linha de comando). Os seguintes recursos são suportados:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Sistema sempre em um estado definido até a atualização do primeiro RPM
    </para>
   </listitem>
   <listitem>
    <para>
     Cancelamento possível até a atualização do primeiro RPM
    </para>
   </listitem>
   <listitem>
    <para>
     Recuperação simples, em caso de erro
    </para>
   </listitem>
   <listitem>
    <para>
     <quote>Rollback</quote> por meio de ferramentas do sistema; sem necessidade de backup/restauração
    </para>
   </listitem>
   <listitem>
    <para>
     Uso de todos os repositórios ativos
    </para>
   </listitem>
   <listitem>
    <para>
     Capacidade de ignorar um pacote de serviço
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.supported-scenarios-and-versions">
  <title>Cenários de software e versões de produto suportados</title>

  <para>
   O SUSE suporta os seguintes cenários, tanto offline quanto online:
  </para>

  <variablelist>
   <varlistentry>
    <term>Online</term>
    <listitem>
     <para>
      SUSE Customer Center (SCC), SMT (Subscription Management Tool), SUSE Manager
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Offline</term>
    <listitem>
     <para>
      DVD de Boot, disco flash, imagem ISO, AutoYaST, <quote>RPM simples</quote> e ferramentas de terceiros
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   A migração das versões a seguir é suportada:
  </para>

  <variablelist>
   <varlistentry>
    <term>Online</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Offline</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 11 SP3/SP4, SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Manualmente/Terceiros</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>Workflow de migração de service pack</title>

  <para>
   É possível executar a migração do pacote de serviço pelo YaST, <command>zypper</command> ou AutoYaST.
  </para>

  <para>
   Antes de começar a migração do pacote de serviço, o sistema deve ser registrado no SUSE Customer Center. Não é possível executar uma migração com repositórios de autocriação derivados de DVDs.
  </para>

  <para>
   Independentemente do método, a migração de service pack consiste nas seguintes etapas:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Localize os destinos de migração possíveis em seus sistemas registrados.
    </para>
   </listitem>
   <listitem>
    <para>
     Selecione um destino de migração.
    </para>
   </listitem>
   <listitem>
    <para>
     Solicite e habilite novos repositórios.
    </para>
   </listitem>
   <listitem>
    <para>
     Execute a migração.
    </para>
   </listitem>
  </orderedlist>



  <para>
   A lista de destinos de migração depende dos produtos que você instalou e registrou. Se você tem uma extensão instalada para a qual ainda não há um novo SP disponível, talvez nenhum destino de migração seja oferecido a você.
  </para>

  <para>
   A lista de destinos de migração disponíveis para o seu host sempre será recuperada do SUSE Customer Center e depende dos produtos ou extensões instalados.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>Cancelando a migração do pacote de serviço</title>

  <para>
   É possível cancelar a migração do pacote de serviço apenas em fases específicas do processo:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Até o upgrade do pacote ser iniciado, há apenas mudanças mínimas no sistema, como para serviços e repositórios. Restaure <filename>/etc/zypp/repos.d/*</filename> para reverter ao estado anterior.
    </para>
   </listitem>
   <listitem>
    <para>
     Depois que o upgrade do pacote é iniciado, você poderá reverter ao estado anterior usando um instantâneo do Snapper (consulte o <xref linkend="cha.snapper"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Depois que o destino de migração for selecionado, o SUSE Customer Center mudará os dados do repositório. Para reverter esse estado manualmente, use <command>SUSEConnect</command> <option>--rollback</option>.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>Migrando com a ferramenta Migração Online (YaST)</title>

  <para>
   Para executar a migração do pacote de serviço com o YaST, use a ferramenta <guimenu>Migração Online</guimenu>. Por padrão, o YaST não instala nenhum pacote de um repositório de terceiros. Se um pacote foi instalado de um repositório de terceiros, o YaST impede que os pacotes sejam substituídos pelo mesmo pacote que vem do SUSE.
  </para>

  <note>
   <title>Reduzir o tamanho da instalação</title>
   <para>
    Ao executar a migração do SP, o YaST instalará todos os pacotes recomendados. Principalmente no caso das instalações mínimas personalizadas, isso pode aumentar o tamanho da instalação do sistema de forma significativa.
   </para>
   <para>
    Para mudar esse comportamento padrão e permitir apenas os pacotes necessários, ajuste <filename>/etc/zypp/zypp.conf</filename> e defina a seguinte variável:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Isso muda o comportamento de todas as operações de pacote, como a instalação de patches ou novos pacotes.
  </para>

  <para>
   Para iniciar a migração do pacote de serviço, faça o seguinte:
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     Execute a atualização online do YaST para obter as atualizações de pacote mais recentes para o seu sistema.
    </para>
   </step>
   <step>
    <para>
     Instale o pacote
     <package>yast2-migration</package>
     e suas dependências (no YaST em <menuchoice> <guimenu>Software</guimenu> <guimenu>Gerenciamento de Software</guimenu> </menuchoice>).
    </para>
   </step>
   <step>
    <para>
     Reinicie o YaST; do contrário, o módulo recém-instalado não será mostrado no centro de controle.
    </para>
   </step>
   <step>
    <para>
     Inicie em YaST <menuchoice> <guimenu>Sistema</guimenu> <guimenu>Migração Online</guimenu> </menuchoice>. O YaST mostra os destinos de migração possíveis e um resumo. Se houver mais de um destino de migração disponível para o seu sistema, selecione um deles na lista.
    </para>
   </step>
   <step>
    <para>
     Selecione um destino de migração na lista e clique em <guimenu>Avançar</guimenu> para continuar.
    </para>
   </step>
   <step>
    <para>
     Se a ferramenta de migração oferecer repositórios de atualização, recomenda-se clicar em <guimenu>Sim</guimenu> para continuar.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark> Se a ferramenta Migração Online encontrar repositórios obsoletos de DVD ou de um servidor local, será altamente recomendado desabilitá-los. Os repositórios obsoletos são de um SP anterior. Qualquer repositório antigo do SCC ou da SMT é removido automaticamente.
    </para>
   </step>
   <step>
    <para>
     Confira o resumo e clique em <guimenu>Avançar</guimenu> para continuar a migração. Clique em <guimenu>Iniciar Atualização</guimenu> para confirmar.
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     Reinicie o sistema após a migração bem-sucedida.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Migrando com o Zypper</title>

  <para>
   Para executar a migração do pacote de serviço com o Zypper, use a ferramenta de linha de comando <command>zypper</command> <option>migration</option>.
  </para>

  <note>
   <title>Reduzir o tamanho da instalação</title>
   <para>
    Ao executar a migração do SP, o YaST instalará todos os pacotes recomendados. Principalmente no caso das instalações mínimas personalizadas, isso pode aumentar o tamanho da instalação do sistema de forma significativa.
   </para>
   <para>
    Para mudar esse comportamento padrão e permitir apenas os pacotes necessários, ajuste <filename>/etc/zypp/zypp.conf</filename> e defina a seguinte variável:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Isso muda o comportamento de todas as operações de pacote, como a instalação de patches ou novos pacotes. Para mudar o comportamento do Zypper para uma única chamada, adicione o parâmetro <option>--no-recommends</option> à linha de comando.
  </para>

  <para>
   Para iniciar a migração do pacote de serviço, faça o seguinte:
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     Registre a máquina do SUSE Linux Enterprise, caso ainda não tenha feito isso:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     Instale as atualizações mais recentes:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     Instale os pacotes
     <package>zypper-migration-plugin</package>
     e suas dependências:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration</screen>
   </step>
   <step>
    <para>
     Execute <command>zypper</command> <option>migration</option>:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     Algumas observações sobre o processo de migração:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Se houver mais de um destino de migração disponível para o seu sistema, o Zypper permitirá selecionar um SP na lista. Isso equivale a ignorar um ou mais SPs. Lembre-se de que a migração online para produtos base (SLES, SLED) permanece disponível apenas entre os SPs de uma versão principal.
      </para>
     </listitem>
     <listitem>
      <para>
       Por padrão, o Zypper usa a opção <option>--no-allow-vendor-change</option>, que é passada para o <command>zypper</command> <option>dup</option>. Se um pacote foi instalado de um repositório de terceiros, essa opção impede que os pacotes sejam substituídos pelo mesmo pacote que vem do SUSE.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark> Se o Zypper encontrar repositórios obsoletos de DVD ou de um servidor local, será altamente recomendado desabilitá-los. Os repositórios SCC ou SMT antigos são automaticamente removidos.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Revise todas as mudanças, principalmente os pacotes que serão removidos. Digite <literal>y</literal> para continuar (o número exato de pacotes para upgrade pode variar de acordo com o sistema):
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     Use as teclas <keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo> ou <keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo> para mover a barra de rolagem no shell.
    </para>
   </step>
   <step>
    <para>
     Reinicie o sistema após a migração bem-sucedida.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>Migrando com o Zypper simples</title>

  <para>
   Se você não pode usar a migração do YaST ou do Zypper, ainda pode migrar com o Zypper simples e algumas interações manuais. Para iniciar a migração do pacote de serviço, faça o seguinte:
  </para>

  <procedure>
   <step>
    <para>
     Atualize as ferramentas de gerenciamento de pacote com os repositórios antigos do SUSE Linux Enterprise:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch--updatestack-only</screen>
   </step>
   <step>
    <para>
     Se o sistema foi registrado, o registro precisa ser cancelado:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     Remova as fontes de instalação e repositórios antigos e ajuste os repositórios de terceiros.
    </para>
   </step>
   <step>
    <para>
     Adicione as novas fontes de instalação, sejam elas locais ou remotas (para o marcador <replaceable>REPOSITÓRIO</replaceable>, consulte a <xref linkend="tab.update.nmm.repositories.sp2"/>):
    </para>
<screen><prompt>root # </prompt><command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     Você também pode usar o SUSE Customer Center ou a SMT (Subscription Management Tool). O comando para o SUSE Linux Enterprise 12 SP1 em x86-64 é:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     Lembre-se de que os upgrades compatíveis com várias arquiteturas não são suportados.
    </para>
   </step>
   <step>
    <para>
     Finalize a migração:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> ref -f -s
<prompt>root # </prompt><command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     O primeiro comando atualiza todos os serviços e repositórios. O segundo comando executa o upgrade da distribuição. Neste ponto, as duas últimas opções são importantes: <option>-no-allow-vendor-change</option> garante que os RPMs de terceiros não sobregravarão os RPMs do sistema básico. A opção <option>--no-recommends</option> garante que os pacotes desmarcados durante a instalação inicial não serão adicionados novamente.
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.update.migr.ownscripts.onlinemigr">
  <title>Migração manual</title>
  <remark>toms 2016-07-13: Is this supported?</remark>
  <para>
   A migração manual ou com scripts próprios precisa de um entendimento mais profundo sobre os componentes do sistema. Portanto, o procedimento a seguir é recomendado apenas para especialistas.
  </para>

  <para>
   Para migrar o sistema manualmente, faça o seguinte:
  </para>

  <procedure>
   <step>
    <para>
     Prepare o sistema:
    </para>
    <substeps>
     <step>
      <para>
       Cancele o registro do sistema atual do SCC:
      </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
     </step>
     <step>
      <para>
       Desabilite as fontes de instalação antigas provenientes do DVD. Por exemplo, inspecione <filename>/etc/zypp/repos.d/SLES12-12-0.repo</filename>.
      </para>
     </step>
     <step>
      <para>
       Procure os repositórios de terceiros e ajuste o URL.
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     Decida se é para adicionar repositórios remotos por meio do SUSE Customer Center ou adicionar repositórios locais:
    </para>
    <variablelist>
     <varlistentry>
      <term>Fonte de Instalação Remota por meio do SCC</term>
      <listitem>
       <para>
        Adicione novas fontes de instalação por meio do canal online:
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 -r <replaceable>CODE</replaceable> -e <replaceable>EMAIL</replaceable></screen>
       <para>
        Verifique se o sistema está registrado corretamente:
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Fonte de Instalação Local</term>
      <listitem>
       <para>
        Adicione uma fonte de instalação local:
       </para>
<screen><prompt>root # </prompt><command>zypper</command> ar -f http://example.com/media/SLES12SP2/
<prompt>root # </prompt><command>zypper</command> ar dvd:///?devices=/dev/sr0 SLES12SP2</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     Atualize todos os repositórios:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 ref -f -s</screen>
   </step>
   <step>
    <para>
     Execute o upgrade da distribuição com <command>zypper dup</command>:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 dup --no-allow-vendor-change --recommends</screen>
   </step>
   <step>
    <para>
     Registre o sistema, caso ainda não tenha feito isso.
    </para>
   </step>
   <step>
    <para>
     Verifique se o sistema está registrado corretamente:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.rollback">
  <title>Voltando um pacote de serviço</title>

  <para>
   Se um pacote de serviço não funcionar para você, o SUSE Linux Enterprise permitirá revertê-lo ao estado anterior antes de iniciar sua migração.
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     Confira uma lista de todos os instantâneos do Snapper:
    </para>
    <screen><prompt>root # </prompt><command>snapper</command> list</screen>
    <para>
     Verifique sua saída e escolha um número para a próxima etapa. Para obter detalhes sobre o Snapper, consulte o <xref linkend="cha.snapper"/>.
    </para>
   </step>
   <step>
    <para>
     Selecione um instantâneo do Snapper para voltar. Forneça o número da etapa anterior:
    </para>
<screen><prompt>root # </prompt><command>snapper</command> rollback <replaceable>NUMBER</replaceable></screen>
   </step>
   <step>
    <para>
     Restaure o carregador de boot (para obter detalhes, consulte o <xref linkend="cha.grub2"/>):
    </para>
<screen><prompt>root # </prompt><command>grub2</command> boot menu</screen>
    <para>
     Durante a inicialização, o registro é redefinido automaticamente.
    </para>
   </step>
   <step>
    <para>
     Verifique se o sistema está registrado corretamente (consulte também a <xref linkend="sec.update.registersystem"/> para obter informações adicionais):
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
   <step>
    <para>
     Se necessário, conserte o registro:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --rollback</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
