<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_migration.xml" version="5.0" xml:id="cha.update.spmigration">
 <title>Migración del paquete de servicio</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>sí</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSE ofrece una herramienta gráfica y una de línea de comandos para la actualización a un nuevo paquete de servicio. Se trata de sencillas herramientas de línea de comandos, una interfaz gráfica de usuario intuitiva, compatibilidad con la <quote>reversión</quote> de los paquetes de servicio, etc. En este capítulo se explica cómo realizar paso a paso una migración del paquete de servicio con estas herramientas.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>Descripción conceptual</title>

  <para>
   SUSE publica nuevos paquetes de servicio para la familia de SUSE Linux Enterprise a intervalos regulares. Para facilitar a los clientes la migración a un nuevo paquete de servicio y reducir el tiempo de inactividad, SUSE admite la migración en línea mientras se esté ejecutando el sistema.
  </para>

  <para>
   A partir de SLE 12 SP2, YaST Wagon se ha sustituido por la migración de YaST (GUI) y la migración de Zypper (línea de comandos). Se admiten las siguientes funciones:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     El sistema siempre está en un estado definido hasta que se actualiza el primer RPM.
    </para>
   </listitem>
   <listitem>
    <para>
     Es posible cancelar hasta que se actualiza el primer RPM.
    </para>
   </listitem>
   <listitem>
    <para>
     La recuperación es fácil si se produce un error.
    </para>
   </listitem>
   <listitem>
    <para>
     La <quote>reversión</quote> se realiza mediante herramientas del sistema; no es necesario realizar una copia de seguridad y restaurar.
    </para>
   </listitem>
   <listitem>
    <para>
     Se usan todos los repositorios activos.
    </para>
   </listitem>
   <listitem>
    <para>
     Es posible omitir un paquete de servicio.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.supported-scenarios-and-versions">
  <title>Escenarios de software admitido y versiones de productos</title>

  <para>
   SUSE admite los siguientes escenarios con conexión o sin ella:
  </para>

  <variablelist>
   <varlistentry>
    <term>En línea</term>
    <listitem>
     <para>
      Centro de servicios al cliente de SUSE (SCC), Herramienta de gestión de suscripciones (SMT), SUSE Manager.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Sin conexión</term>
    <listitem>
     <para>
      DVD de arranque, memoria USB, imagen ISO, AutoYaST, <quote>RPM simple</quote> y herramientas de otros fabricantes.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Se admite la migración desde las siguientes versiones:
  </para>

  <variablelist>
   <varlistentry>
    <term>En línea</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Sin conexión</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 11 SP3/SP4, SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Manual/Otros fabricantes</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>Flujo de trabajo de migración del paquete de servicio</title>

  <para>
   Es posible ejecutar una migración del paquete de servicio mediante YaST, <command>zypper</command> o AutoYaST.
  </para>

  <para>
   Antes de que pueda iniciar una migración del paquete de servicio, el sistema debe estar registrado en el Centro de servicio al cliente de SUSE. No es posible llevar a cabo una migración con repositorios que haya creado usted mismo a partir de los DVD.
  </para>

  <para>
   Independientemente del método utilizado, la migración de un paquete de servicio consta de los pasos siguientes:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Buscar posibles destinos de migración en los sistemas registrados.
    </para>
   </listitem>
   <listitem>
    <para>
     Seleccionar un destino de migración.
    </para>
   </listitem>
   <listitem>
    <para>
     Pedir y habilitar nuevos repositorios.
    </para>
   </listitem>
   <listitem>
    <para>
     Ejecutar la migración.
    </para>
   </listitem>
  </orderedlist>



  <para>
   La lista de destinos de migración depende de los productos que haya instalado y registrado. Si tiene una extensión instalada para la que aún no haya disponible un paquete de servicio nuevo, puede que no se le ofrezca ningún destino de migración.
  </para>

  <para>
   La lista de destinos de migración disponibles para el host siempre se recupera desde el Centro de servicios al cliente de SUSE y depende de los productos o extensiones instalados.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>Cancelación de la migración del paquete de servicio</title>

  <para>
   La migración del paquete de servicio solo se puede cancelar en etapas concretas durante el proceso de migración:
  </para>

  <orderedlist>
   <listitem>
    <para>
     Hasta que se inicia la actualización del paquete, solo hay cambios mínimos en el sistema, como en los servicios y repositorios. Restaure <filename>/etc/zypp/repos.d/*</filename> para revertir el sistema al estado anterior.
    </para>
   </listitem>
   <listitem>
    <para>
     Cuando se inicia la actualización del paquete, puede volver al estado anterior mediante una instantánea de Snapper (consulte <xref linkend="cha.snapper"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Después de seleccionar el destino de migración, el Centro de servicios al cliente de SUSE cambia los datos del repositorio. Para revertir este estado manualmente, utilice <command>SUSEConnect</command> <option>--rollback</option>.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>Migración con la herramienta de migración en línea (YaST)</title>

  <para>
   Para realizar la migración de un paquete de servicio con YaST, use la herramienta <guimenu>Migración en línea</guimenu>. Por defecto, YaST no instala ningún paquete desde repositorios de otros fabricantes. Si se ha instalado un paquete desde un repositorio de otro fabricante, YaST impide que los paquetes se sustituyan por los mismos paquetes provenientes de SUSE.
  </para>

  <note>
   <title>reducción del tamaño de la instalación</title>
   <para>
    Al realizar la migración del paquete de servicio, YaST instala todos los paquetes recomendados. Especialmente en el caso de las instalaciones mínimas personalizadas, esto puede aumentar el tamaño de instalación del sistema considerablemente.
   </para>
   <para>
    Para cambiar este comportamiento por defecto y permitir solo los paquetes necesarios, ajuste <filename>/etc/zypp/zypp.conf</filename> y defina la variable siguiente:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Esto cambia el comportamiento de todas las operaciones del paquete, como la instalación de parches o nuevos paquetes.
  </para>

  <para>
   Para iniciar la migración del paquete de servicio, haga lo siguiente:
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     Ejecute la actualización en línea de YaST para obtener las actualizaciones más recientes del paquete para su sistema.
    </para>
   </step>
   <step>
    <para>
     Instale el paquete
     <package>yast2-migration</package>
     y sus dependencias (en YaST en <menuchoice> <guimenu>Software</guimenu> <guimenu>Gestión de software</guimenu> </menuchoice>).
    </para>
   </step>
   <step>
    <para>
     Reinicie YaST, o el módulo recién instalado no se mostrará en el Centro de control.
    </para>
   </step>
   <step>
    <para>
     Inicie en YaST <menuchoice> <guimenu>Sistema</guimenu> <guimenu>Migración en línea</guimenu> </menuchoice>. YaST muestra los destinos de migración posibles y un resumen. Si hay disponible más de un destino de migración para el sistema, seleccione uno en la lista.
    </para>
   </step>
   <step>
    <para>
     Seleccione un destino de migración de la lista y haga clic en <guimenu>Siguiente</guimenu>.
    </para>
   </step>
   <step>
    <para>
     En caso de que la herramienta de migración ofrezca repositorios de actualización, se recomienda continuar haciendo clic en <guimenu>Sí</guimenu>.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark> Si la herramienta Migración en línea encuentra repositorios obsoletos provenientes del DVD o de un servidor local, se recomienda encarecidamente inhabilitarlos. Los repositorios obsoletos proceden de un paquete de servicio anterior. Los repositorios antiguos de SCC o SMT se eliminan automáticamente.
    </para>
   </step>
   <step>
    <para>
     Revise el resumen y haga clic en <guimenu>Siguiente</guimenu> para continuar con la migración. Para confirmar, haga clic en <guimenu>Iniciar actualización</guimenu>.
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     Cuando se complete correctamente la migración, reinicie el sistema.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Migración con Zypper</title>

  <para>
   Para realizar la migración de un paquete de servicio con Zypper, use la herramienta de línea de comandos <command>zypper</command> <option>migration</option>.
  </para>

  <note>
   <title>reducción del tamaño de la instalación</title>
   <para>
    Al realizar la migración del paquete de servicio, YaST instala todos los paquetes recomendados. Especialmente en el caso de las instalaciones mínimas personalizadas, esto puede aumentar el tamaño de instalación del sistema considerablemente.
   </para>
   <para>
    Para cambiar este comportamiento por defecto y permitir solo los paquetes necesarios, ajuste <filename>/etc/zypp/zypp.conf</filename> y defina la variable siguiente:
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   Esto cambia el comportamiento de todas las operaciones del paquete, como la instalación de parches o nuevos paquetes. Para cambiar el comportamiento de Zypper para una sola llamada, añada el parámetro <option>--no-recommends</option> en la línea de comandos.
  </para>

  <para>
   Para iniciar la migración del paquete de servicio, haga lo siguiente:
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     Si aún no lo ha hecho, registre el equipo en SUSE Linux Enterprise:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     Instale las actualizaciones más recientes:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     Instale los paquetes
     <package>zypper-migration-plugin</package>
     y sus dependencias:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration</screen>
   </step>
   <step>
    <para>
     Ejecute <command>zypper</command> <option>migration</option>:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     Notas sobre el proceso de migración:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Si hay disponible más de un destino de migración para el sistema, Zypper permite seleccionar uno en la lista. Esto es lo mismo que omitir uno o varios paquetes de servicio. Tenga en cuenta que la migración en línea de productos base (SLES y SLED) sigue estando disponible solo entre los paquetes de servicio de una versión principal.
      </para>
     </listitem>
     <listitem>
      <para>
       Por defecto, Zypper usa la opción <option>--no-allow-vendor-change</option>, que se pasa a <command>zypper</command> <option>dup</option>. Si se ha instalado un paquete desde un repositorio de otro fabricante, esta opción impide que los paquetes se sustituyan por los mismos paquetes provenientes de SUSE.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark> Si Zypper encuentra repositorios obsoletos provenientes del DVD o de un servidor local, se recomienda encarecidamente inhabilitarlos. Los repositorios del SCC o de la SMT antiguos se eliminan automáticamente.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Revise todos los cambios, sobre todo los paquetes que se van a eliminar. Para continuar, escriba <literal>y</literal> (el número exacto de paquetes para actualizar puede variar en su sistema):
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     Use las teclas <keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo> o <keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo> para desplazarse por la shell.
    </para>
   </step>
   <step>
    <para>
     Cuando se complete correctamente la migración, reinicie el sistema.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>Migración con Zypper simple</title>

  <para>
   Si no puede utilizar la migración con YaST o la migración con Zypper, aún puede migrar con Zypper normal y alguna interacción manual. Para iniciar una migración del paquete de servicio, haga lo siguiente:
  </para>

  <procedure>
   <step>
    <para>
     Actualice las herramientas de gestión del paquete con los repositorios de SUSE Linux Enterprise anteriores:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch--updatestack-only</screen>
   </step>
   <step>
    <para>
     Si el sistema está registrado, debe anular el registro:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     Elimine los orígenes de instalación y los repositorios antiguos y ajuste los repositorios de otros fabricantes.
    </para>
   </step>
   <step>
    <para>
     Añadir los nuevos orígenes de instalación, ya sea locales o remoto fuentes (por el espacio reservado<replaceable>REPOSITORIO</replaceable>, consulte<xref linkend="tab.update.nmm.repositories.sp2"/>):
    </para>
<screen><prompt>root # </prompt><command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     También puede usar el Centro de servicios al cliente de SUSE o la Herramienta de gestión de suscripciones. El comando para SUSE Linux Enterprise 12 SP1 en x86-64 es:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     Tenga en cuenta, no se admiten actualizaciones de arquitecturas cruzadas.
    </para>
   </step>
   <step>
    <para>
     Finalice la migración:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> ref -f -s
<prompt>root # </prompt><command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     El primer comando actualiza todos los servicios y repositorios. El segundo comando lleva a cabo una actualización de la distribución. En este caso, las dos últimas opciones son importantes: <option>-no-allow-vendor-change</option> garantiza que los RPM de otros fabricantes no sobrescribirán los RPM del sistema base. La opción <option>--no-recommends</option> garantiza que el paquete deseleccionado durante la instalación inicial no se añadirá de nuevo.
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.update.migr.ownscripts.onlinemigr">
  <title>Migración manual</title>
  <remark>toms 2016-07-13: Is this supported?</remark>
  <para>
   Para realizar una migración manual o guiones propios es necesario un conocimiento más profundo acerca de las partes del sistema. Por lo tanto, el procedimiento siguiente solo se recomienda para expertos.
  </para>

  <para>
   Para migrar el sistema manualmente, haga lo siguiente:
  </para>

  <procedure>
   <step>
    <para>
     Prepare el sistema:
    </para>
    <substeps>
     <step>
      <para>
       Anule el registro del sistema actual de SCC:
      </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
     </step>
     <step>
      <para>
       Inhabilite los orígenes de instalación anteriores procedentes del DVD. Por ejemplo, revise <filename>/etc/zypp/repos.d/SLES12-12-0.repo</filename>.
      </para>
     </step>
     <step>
      <para>
       Busque los repositorios de otros fabricantes y ajuste la URL.
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     Decida si desea añadir repositorios remotos a través del Centro de servicios al cliente de SUSE o añada repositorios locales:
    </para>
    <variablelist>
     <varlistentry>
      <term>Origen de instalación remoto a través de SCC</term>
      <listitem>
       <para>
        Añada orígenes de instalación nuevos a través del canal en línea:
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 -r <replaceable>CODE</replaceable> -e <replaceable>EMAIL</replaceable></screen>
       <para>
        Compruebe si el sistema se ha registrado correctamente:
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Origen de instalación local</term>
      <listitem>
       <para>
        Añada un origen de instalación local:
       </para>
<screen><prompt>root # </prompt><command>zypper</command> ar -f http://example.com/media/SLES12SP2/
<prompt>root # </prompt><command>zypper</command> ar dvd:///?devices=/dev/sr0 SLES12SP2</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     Actualice todos los repositorios:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 ref -f -s</screen>
   </step>
   <step>
    <para>
     Ejecute la actualización de la distribución con <command>zypper dup</command>.
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 dup --no-allow-vendor-change --recommends</screen>
   </step>
   <step>
    <para>
     Si aún no lo ha hecho, registre el sistema.
    </para>
   </step>
   <step>
    <para>
     Compruebe que el sistema se ha registrado correctamente:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.rollback">
  <title>Reversión de un paquete de servicio</title>

  <para>
   Si un paquete de servicio no funciona, SUSE Linux Enterprise permite revertirlo a su estado anterior antes de iniciar la migración.
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     Obtenga una lista de todas las instantáneas de Snapper:
    </para>
    <screen><prompt>root # </prompt><command>snapper</command> list</screen>
    <para>
     Revise el resultado y elija un número para el paso siguiente. Para obtener información sobre Snapper, consulte <xref linkend="cha.snapper"/>.
    </para>
   </step>
   <step>
    <para>
     Seleccione una instantánea de Snapper para realizar la reversión. Proporcione el número seleccionado en el paso anterior:
    </para>
<screen><prompt>root # </prompt><command>snapper</command> rollback <replaceable>NUMBER</replaceable></screen>
   </step>
   <step>
    <para>
     Restaure el cargador de arranque (para obtener información, consulte <xref linkend="cha.grub2"/>):
    </para>
<screen><prompt>root # </prompt><command>grub2</command> boot menu</screen>
    <para>
     Durante el arranque, el registro se restablece automáticamente.
    </para>
   </step>
   <step>
    <para>
     Compruebe si el sistema se ha registrado correctamente (consulte también <xref linkend="sec.update.registersystem"/> para obtener información adicional):
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
   <step>
    <para>
     Si fuera necesario, repare el registro:
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --rollback</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
