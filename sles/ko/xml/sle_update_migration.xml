<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="sle_update_migration.xml" version="5.0" xml:id="cha.update.spmigration">
 <title>서비스 팩 마이그레이션</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>예</dm:translation>
  </dm:docmanager>
  <abstract>
   <para>
    SUSE는 새로운 서비스 팩으로 업그레이드하기 위한 그래픽 도구와 명령줄 도구를 제공합니다. 여기에는 단순한 명령줄 도구, 직관적인 그래픽 사용자 인터페이스, 서비스 팩의 <quote>롤백</quote> 지원 등이 포함됩니다. 이 장에서는 이러한 도구를 사용하여 서비스 팩 마이그레이션을 수행하는 방법을 단계별로 설명합니다.
   </para>
  </abstract>
 </info>
 <sect1 xml:id="sec.update.migr.conceptual-overview">
  <title>개념 개요</title>

  <para>
   SUSE는 정기적으로 SUSE Linux Enterprise 제품군을 위한 새로운 서비스 팩을 공개합니다. 고객이 쉽게 새로운 서비스 팩으로 마이그레이션하고 작동 중지 시간을 최소화할 수 있도록 시스템 가동 중에 온라인 마이그레이션을 지원합니다.
  </para>

  <para>
   SLE 12 SP2부터 YaST Wagon이 YaST 마이그레이션(GUI)과 Zypper 마이그레이션(명령줄)으로 대체되었습니다. 다음 기능이 지원됩니다.
  </para>

  <itemizedlist>
   <listitem>
    <para>
     첫 번째 RPM을 업데이트할 때까지 시스템이 항상 정의된 상태를 유지
    </para>
   </listitem>
   <listitem>
    <para>
     첫 번째 RPM을 업데이트할 때까지는 취소 가능
    </para>
   </listitem>
   <listitem>
    <para>
     오류 발생 시 간단하게 복구
    </para>
   </listitem>
   <listitem>
    <para>
     시스템 도구를 통한 <quote>롤백</quote>, 백업/복원 필요 없음
    </para>
   </listitem>
   <listitem>
    <para>
     모든 활성 리포지토리 사용
    </para>
   </listitem>
   <listitem>
    <para>
     서비스 팩을 건너뛰는 기능
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.supported-scenarios-and-versions">
  <title>지원되는 소프트웨어 시나리오 및 제품 버전</title>

  <para>
   SUSE는 오프라인 또는 온라인에서 다음과 같은 시나리오를 지원합니다.
  </para>

  <variablelist>
   <varlistentry>
    <term>온라인</term>
    <listitem>
     <para>
      SCC(SUSE 고객 센터), SMT(구독 관리 도구), SUSE Manager
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>오프라인</term>
    <listitem>
     <para>
      부팅 DVD, 플래시 디스크, ISO 이미지, AutoYaST, <quote>일반 RPM</quote> 및 타사 도구
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   다음 버전으로부터의 마이그레이션이 지원됩니다.
  </para>

  <variablelist>
   <varlistentry>
    <term>온라인</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>오프라인</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 11 SP3/SP4, SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>수동/타사</term>
    <listitem>
     <para>
      SUSE Linux Enterprise 12
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec.update.migr.workflow">
  <title>서비스 팩 마이그레이션 워크플로</title>

  <para>
   서비스 팩 마이그레이션은 YaST, <command>zypper</command>, 또는 AutoYaST로 실행할 수 있습니다.
  </para>

  <para>
   서비스 팩 마이그레이션을 시작하려면 먼저 SUSE 고객 센터에서 시스템을 등록해야 합니다. DVD에서 온 자체 빌드 리포지토리로는 마이그레이션을 수행할 수 없습니다.
  </para>

  <para>
   방법에 관계없이 서비스 팩 마이그레이션은 다음 단계로 구성됩니다.
  </para>

  <orderedlist>
   <listitem>
    <para>
     등록된 시스템에서 가능한 마이그레이션 대상을 찾습니다.
    </para>
   </listitem>
   <listitem>
    <para>
     하나의 마이그레이션 대상을 선택합니다.
    </para>
   </listitem>
   <listitem>
    <para>
     새 리포지토리를 요청하고 활성화합니다.
    </para>
   </listitem>
   <listitem>
    <para>
     마이그레이션을 실행합니다.
    </para>
   </listitem>
  </orderedlist>



  <para>
   마이그레이션 대상 목록은 설치 및 등록한 제품에 따라 다릅니다. 새 SP를 아직 사용할 수 없는 확장을 설치한 경우 마이그레이션 대상이 제공되지 않을 수 있습니다.
  </para>

  <para>
   호스트에서 사용 가능한 마이그레이션 대상 목록은 항상 SUSE 고객 센터에서 검색되며, 설치된 제품 또는 확장에 따라 달라집니다.
  </para>
 </sect1>
 <sect1 xml:id="sec.update.migr.cancel.spm">
  <title>서비스 팩 마이그레이션 취소</title>

  <para>
   서비스 팩 마이그레이션은 마이그레이션 프로세스 중 특정 단계에서만 취소할 수 있습니다.
  </para>

  <orderedlist>
   <listitem>
    <para>
     패키지 업그레이드를 시작하기 전에는 서비스, 리포지토리 등 시스템 변경이 최소화됩니다. <filename>/etc/zypp/repos.d/*</filename>를 복구하여 이전 상태로 돌아갑니다.
    </para>
   </listitem>
   <listitem>
    <para>
     패키지 업그레이드 시작 후에는 스냅퍼 스냅샷을 사용하여 이전 상태로 돌아갈 수 있습니다(<xref linkend="cha.snapper"/> 참조).
    </para>
   </listitem>
   <listitem>
    <para>
     마이그레이션 대상을 선택하면 SUSE 고객 센터에서 리포지토리 데이터를 변경합니다. 이 상태를 수동으로 되돌리려면 <command>SUSEConnect</command> <option>--rollback</option>을 사용하십시오.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec.update.migr.yast.onlinemigr">
  <title>온라인 마이그레이션 도구(YaST)를 통한 마이그레이션</title>

  <para>
   YaST를 사용하여 서비스 팩 마이그레이션을 수행하려면 <guimenu>온라인 마이그레이션</guimenu> 도구를 사용하십시오. 기본적으로 YaST는 타사 리포지토리에서 패키지를 설치하지 않습니다. 타사 리포지토리에서 패키지가 설치된 경우 YaST는 패키지가 SUSE에서 가져오는 동일한 패키지로 바뀌지 않도록 방지합니다.
  </para>

  <note>
   <title>설치 크기 줄이기 </title>
   <para>
    SIP 마이그레이션을 수행할 때 YaST는 모든 권장 패키지를 설치합니다. 따라서 특히 사용자 정의 최소 설치의 경우 시스템의 설치 크기가 상당히 증가할 수 있습니다.
   </para>
   <para>
    이 기본 동작을 변경하고 필요한 패키지만 허용하려면 <filename>/etc/zypp/zypp.conf</filename>를 조정하고 다음 변수를 설정하십시오.
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   그러면 모든 패키지 작업의 동작이 변경됩니다(예: 패치 또는 새로운 패키지의 설치).
  </para>

  <para>
   서비스 팩 마이그레이션을 시작하려면 다음을 수행하십시오.
  </para>

  <procedure xml:id="pro.update.migr.yast">
   <step>
    <para>
     YaST 온라인 업데이트를 실행하여 시스템을 위한 최신 패키지 업데이트를 받습니다.
    </para>
   </step>
   <step>
    <para>
     yast2-migration
     <package>패키지 및</package>
     종속 항목을 설치합니다(YaST 에서 <menuchoice> <guimenu>소프트웨어</guimenu> <guimenu>소프트웨어 관리</guimenu> </menuchoice>아래).
    </para>
   </step>
   <step>
    <para>
     YaST를 재시작합니다. 그렇지 않으면 새로 설치한 모듈이 관리 센터에 표시되지 않습니다.
    </para>
   </step>
   <step>
    <para>
     YaST <menuchoice> <guimenu>시스템</guimenu> <guimenu>온라인 마이그레이션</guimenu> </menuchoice>에서 시작합니다. 가능한 마이그레이션 대상 및 요약이 표시됩니다. 시스템에서 마이그레이션 대상을 둘 이상 사용할 수 있는 경우 목록에서 하나를 선택합니다.
    </para>
   </step>
   <step>
    <para>
     목록에서 마이그레이션 대상을 하나 선택하고 <guimenu>다음</guimenu>을 선택하여 계속 진행합니다.
    </para>
   </step>
   <step>
    <para>
     마이그레이션 도구가 업데이트 리포지토리를 제공할 경우 <guimenu>예</guimenu>를 선택하여 진행하는 것이 좋습니다.
    </para>
   </step>
   <step>
    <para>
     <remark>toms 2015-09-09: FATE#319140</remark> 온라인 마이그레이션 도구가 DVD 또는 로컬 서버에서 구식 리포지토리를 찾는 경우 해당 리포지토리를 비활성화하는 것이 좋습니다. 구식 리포지토리는 이전 SP에서 온 것입니다. SCC 또는 SMT의 오래된 리포지토리는 자동으로 제거됩니다.
    </para>
   </step>
   <step>
    <para>
     요약을 확인하고 <guimenu>[다음]</guimenu>을 눌러 마이그레이션을 계속합니다. <guimenu>업데이트 시작</guimenu>을 눌러 확인합니다.
    </para>
    <remark>toms 2016-07-13: What to do in case of problems?</remark>
   </step>
   <step>
    <para>
     마이그레이션이 끝나면 시스템을 재시작합니다.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.zypper.onlinemigr">
  <title>Zypper를 사용한 마이그레이션</title>

  <para>
   Zypper를 사용하여 서비스 팩 마이그레이션을 수행하려면 명령줄 도구 <command>zypper</command> <option>migration</option>을 사용합니다.
  </para>

  <note>
   <title>설치 크기 줄이기 </title>
   <para>
    SIP 마이그레이션을 수행할 때 YaST는 모든 권장 패키지를 설치합니다. 따라서 특히 사용자 정의 최소 설치의 경우 시스템의 설치 크기가 상당히 증가할 수 있습니다.
   </para>
   <para>
    이 기본 동작을 변경하고 필요한 패키지만 허용하려면 <filename>/etc/zypp/zypp.conf</filename>를 조정하고 다음 변수를 설정하십시오.
   </para>
<screen>solver.onlyRequires = true
installRecommends=false # or commented</screen>
  </note>

  <para>
   그러면 모든 패키지 작업의 동작이 변경됩니다(예: 패치 또는 새로운 패키지의 설치). 단일 호출에 대한 Zypper의 동작을 변경하려면 명령줄에 <option>--no-recommends</option> 파라미터를 추가합니다.
  </para>

  <para>
   서비스 팩 마이그레이션을 시작하려면 다음을 수행하십시오.
  </para>

  <procedure xml:id="pro.update.migr.zypper">
   <step>
    <para>
     SUSE Linux Enterprise 시스템을 아직 등록하지 않았다면 지금 등록합니다.
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --regcode <replaceable>YOUR_REGISTRATION_CODE</replaceable></screen>
   </step>
   <step>
    <para>
     최신 업데이트를 설치합니다:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch</screen>
   </step>
   <step>
    <para>
     zypper-migration-plugin
     <package>패키지 및</package>
     해당 종속성을 설치합니다:
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration</screen>
   </step>
   <step>
    <para>
     <command>zypper</command> <option>migration</option>을 실행합니다.
    </para>
<screen><prompt>root # </prompt><command>zypper</command> migration
Executing 'zypper  patch-check'

Refreshing service 'SUSE_Linux_Enterprise_Server_12_x86_64'.
Loading repository data...
Reading installed packages...
0 patches needed (0 security patches)

Available migrations:

    1 | SUSE Linux Enterprise Server 12 SP1 x86_64
    2 | SUSE Linux Enterprise Server 12 SP2 x86_64</screen>
    <para>
     마이그레이션 프로세스에 대한 몇 가지 참고 사항:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       시스템에서 마이그레이션 대상을 둘 이상 사용할 수 있는 경우 목록에서 SP를 하나 선택할 수 있습니다. 이는 하나 이상의 SP를 건너뛰는 것과 같습니다. 기본 제품(SLES, SLED)에 대한 온라인 마이그레이션은 주요 버전의 SP 사이에서만 가능합니다. 
      </para>
     </listitem>
     <listitem>
      <para>
       기본적으로 Zypper는 <command>zypper</command> <option>dup</option>로 전달되는 <option>--no-allow-vendor-change</option> 옵션을 사용합니다. 타사 리포지토리에서 패키지가 설치된 경우 이 옵션은 패키지가 SUSE에서 가져오는 동일한 패키지로 바뀌지 않도록 방지합니다.
      </para>
     </listitem>
     <listitem>
      <para>
       <remark>toms 2015-09-09: FATE#319140</remark> Zypper가 DVD 또는 로컬 서버에서 구식 리포지토리를 찾는 경우 해당 리포지토리를 비활성화하는 것이 좋습니다. 오래된 SCC 또는 SMT 리포지토리는 자동으로 제거됩니다.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     모든 변경 사항 특히, 제거될 패키지를 검토합니다. <literal>y</literal>를 입력하여 계속합니다(업그레이드할 정확한 패키지 수는 시스템에 따라 다를 수 있음).
    </para>
<screen>266 packages to upgrade, 54 to downgrade, 17 new, 8 to reinstall, 5 to remove, 1 to change arch.
Overall download size: 285.1 MiB. Already cached: 0 B  After the operation, additional 139.8 MiB will be used.
Continue? [y/n/? shows all options] (y):</screen>
    <para>
     셸에서 스크롤하려면 <keycombo> <keycap function="shift"/> <keycap function="pageup"/> </keycombo> 또는 <keycombo> <keycap function="shift"/> <keycap function="pagedown"/> </keycombo> 키를 사용합니다.
    </para>
   </step>
   <step>
    <para>
     마이그레이션이 끝나면 시스템을 재시작합니다.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.plainzypper.onlinemigr">
  <title>일반 Zypper를 사용한 마이그레이션</title>

  <para>
   YaST 마이그레이션 또는 Zypper 마이그레이션을 사용할 수 없어도 일반 Zypper 및 몇 가지 수동 작업을 사용하여 마이그레이션할 수 있습니다. 서비스 팩 마이그레이션을 시작하려면 다음을 수행하십시오.
  </para>

  <procedure>
   <step>
    <para>
     이전 SUSE Linux Enterprise 리포지토리를 사용하여 패키지 관리 도구를 업데이트합니다.
    </para>
<screen><prompt>root # </prompt><command>zypper</command> patch--updatestack-only</screen>
   </step>
   <step>
    <para>
     시스템이 등록된 경우 등록을 해제해야 합니다.
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
   </step>
   <step>
    <para>
     이전 설치 원본과 리포지토리를 제거하고 타사 리포지토리를 조정합니다.
    </para>
   </step>
   <step>
    <para>
     로컬 또는 원격 원본인 새로운 설치 원본을 추가합니다(<replaceable>REPOSITORY</replaceable>자리 표시자는 <xref linkend="tab.update.nmm.repositories.sp2"/>를 참조하십시오.):
    </para>
<screen><prompt>root # </prompt><command>zypper</command> addrepo <replaceable>REPOSITORY</replaceable></screen>
    <para>
     SUSE 고객 센터나 구독 관리 도구를 사용할 수도 있습니다. x86-64에서 SUSE Linux Enterprise 12 SP1을 위한 명령은 다음과 같습니다.
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 <replaceable>OPTIONS</replaceable></screen>
    <para>
     아키텍처 간 업그레이드는 지원되지 않습니다.
    </para>
   </step>
   <step>
    <para>
     마이그레이션을 마무리합니다.
    </para>
<screen><prompt>root # </prompt><command>zypper</command> ref -f -s
<prompt>root # </prompt><command>zypper</command> dup --no-allow-vendor-change --no-recommends</screen>
    <para>
     첫 번째 명령은 모든 서비스 및 리포지토리를 업데이트합니다. 두 번째 명령은 배포 업그레이드를 수행합니다. 여기서 마지막 두 옵션이 중요합니다. <option>-no-allow-vendor-change</option>는 타사 RPM이 기본 시스템의 RPM을 덮어쓰지 않도록 합니다. <option>--no-recommends</option> 옵션은 초기 설치 중 선택 취소된 패키지가 다시 추가되지 않도록 합니다.
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.update.migr.ownscripts.onlinemigr">
  <title>수동 마이그레이션</title>
  <remark>toms 2016-07-13: Is this supported?</remark>
  <para>
   수동 마이그레이션이나 자체 스크립트 마이그레이션의 경우 시스템 요소에 대한 보다 깊이 있는 이해가 필요합니다. 따라서 다음 절차는 전문가에게만 권장합니다.
  </para>

  <para>
   시스템을 수동으로 마이그레이션하려면 다음을 수행하십시오.
  </para>

  <procedure>
   <step>
    <para>
     시스템을 준비합니다.
    </para>
    <substeps>
     <step>
      <para>
       SCC에서 현재 시스템의 등록을 취소합니다.
      </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --de-register</screen>
     </step>
     <step>
      <para>
       DVD의 이전 설치 원본을 비활성화합니다. 예를 들어 <filename>/etc/zypp/repos.d/SLES12-12-0.repo</filename>를 검사합니다.
      </para>
     </step>
     <step>
      <para>
       타사 리포지토리를 찾아서 URL을 조정합니다.
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     SUSE 고객 센터를 통해 원격 리포지토리를 추가할지, 아니면 로컬 리포지토리를 추가할지를 결정합니다.
    </para>
    <variablelist>
     <varlistentry>
      <term>SCC를 통한 원격 설치 원본</term>
      <listitem>
       <para>
        온라인 채널을 통해 새 설치 원본을 추가합니다.
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> -p SLES/12.2/x86_64 -r <replaceable>CODE</replaceable> -e <replaceable>EMAIL</replaceable></screen>
       <para>
        시스템이 제대로 등록되어 있는지 확인합니다.
       </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>로컬 설치 원본</term>
      <listitem>
       <para>
        로컬 설치 원본을 추가합니다.
       </para>
<screen><prompt>root # </prompt><command>zypper</command> ar -f http://example.com/media/SLES12SP2/
<prompt>root # </prompt><command>zypper</command> ar dvd:///?devices=/dev/sr0 SLES12SP2</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     모든 리포지토리를 새로 고칩니다.
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 ref -f -s</screen>
   </step>
   <step>
    <para>
     <command>zypper dup</command>를 사용하여 배포 업그레이드를 실행합니다.
    </para>
<screen><prompt>root # </prompt><command>zypper</command> --releasever 12.2 dup --no-allow-vendor-change --recommends</screen>
   </step>
   <step>
    <para>
     아직 시스템을 등록하지 않았다면 지금 등록합니다.
    </para>
   </step>
   <step>
    <para>
     시스템이 정상적으로 등록되었는지 확인합니다.
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.update.migr.rollback">
  <title>서비스 팩 롤백</title>

  <para>
   서비스 팩이 작동하지 않을 경우 SUSE Linux Enterprise는 서비스 팩 마이그레이션이 시작되기 이전 상태로 돌아가도록 지원합니다.
  </para>

  <procedure xml:id="pro.update.migr.rollback">
   <step>
    <para>
     모든 스냅퍼 스냅샷 목록을 가져옵니다.
    </para>
    <screen><prompt>root # </prompt><command>snapper</command> list</screen>
    <para>
     출력을 확인하고 다음 단계에 대한 숫자를 선택합니다. 스냅퍼에 관한 자세한 정보는 <xref linkend="cha.snapper"/> 항목을 참조하십시오.
    </para>
   </step>
   <step>
    <para>
     롤백할 스냅퍼 스냅샷을 선택합니다. 이전 단계의 숫자를 입력합니다.
    </para>
<screen><prompt>root # </prompt><command>snapper</command> rollback <replaceable>NUMBER</replaceable></screen>
   </step>
   <step>
    <para>
     부트 로더를 복원합니다(자세한 정보는 <xref linkend="cha.grub2"/> 참조).
    </para>
<screen><prompt>root # </prompt><command>grub2</command> boot menu</screen>
    <para>
     부팅 중에 등록이 자동으로 재설정됩니다.
    </para>
   </step>
   <step>
    <para>
     시스템이 올바르게 등록되었는지 확인합니다(<xref linkend="sec.update.registersystem"/>에서 추가 정보 확인).
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --status</screen>
   </step>
   <step>
    <para>
     필요한 경우 등록을 복원합니다.
    </para>
<screen><prompt>root # </prompt><command>SUSEConnect</command> --rollback</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
